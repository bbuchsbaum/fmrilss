% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/lss_design.R
\name{lss_design}
\alias{lss_design}
\title{LSS Analysis with fmridesign Objects}
\usage{
lss_design(
  Y,
  event_model,
  baseline_model = NULL,
  method = "oasis",
  oasis = list(),
  prewhiten = NULL,
  blockids = NULL,
  validate = TRUE,
  ...
)
}
\arguments{
\item{Y}{Numeric matrix of fMRI data (timepoints × voxels).}

\item{event_model}{An event_model object from \code{fmridesign::event_model()}.
This defines the trial-wise or condition-wise task design. For LSS, typically
created with \code{trialwise()} to generate one regressor per trial.}

\item{baseline_model}{Optional baseline_model object from
\code{fmridesign::baseline_model()}. Defines drift correction, block intercepts,
and nuisance regressors. If NULL, basic baseline intercepts are
auto-injected: per-run intercepts derived from `blockids` (or the
sampling frame) are used to ensure proper baseline modeling.}

\item{method}{LSS method to use. Currently only "oasis" is supported for
event_model integration.}

\item{oasis}{List of OASIS-specific options (see \code{?lss} for details).
Note: \code{design_spec} is not used when providing event_model.}

\item{prewhiten}{Optional prewhitening specification (see \code{?lss}).}

\item{blockids}{Optional block/run identifiers for event_model. If NULL,
extracted from event_model$blockids.}

\item{validate}{Logical. If TRUE (default), performs validation checks on
design compatibility, collinearity, and temporal alignment.}

\item{...}{Additional arguments passed to the underlying LSS method.}
}
\value{
Matrix of trial-wise beta estimates (trials × voxels), or
  (trials × basis_functions) × voxels for multi-basis HRFs.
}
\description{
Perform Least Squares Separate (LSS) analysis using event_model and
baseline_model objects from the fmridesign package. This provides a
streamlined interface for complex designs with multi-condition, parametric
modulators, and structured nuisance handling.
}
\details{
\strong{Design Specification:}

The \code{event_model} should typically use \code{trialwise()} for LSS:
\preformatted{
  emod <- event_model(onset ~ trialwise(basis = "spmg1"),
                      data = events,
                      block = ~run,
                      sampling_frame = sframe)
}

For factorial designs (e.g., estimating condition-level betas separately):
\preformatted{
  emod <- event_model(onset ~ hrf(condition),
                      data = events,
                      block = ~run,
                      sampling_frame = sframe)
}

\strong{Baseline Model:}

If provided, baseline_model components are mapped as follows:
\itemize{
  \item \code{drift} and \code{block} terms → Z parameter (fixed effects)
  \item \code{nuisance} term → Nuisance parameter (confounds)
}

\strong{Multi-Run Handling:}

Both event_model and baseline_model must use the same \code{sampling_frame}.
Run structure is automatically respected. Event onsets should be run-relative
(resetting to 0 each run) as per fmridesign convention - conversion to global
time is handled automatically.

\strong{Validation:}

When \code{validate = TRUE}, the function checks:
\itemize{
  \item Temporal alignment: nrow(Y) matches total scans in sampling_frame
  \item Collinearity: Design matrix condition number < 30
  \item Compatibility: event_model and baseline_model use same sampling_frame
}
}
\examples{
\dontrun{
library(fmridesign)
library(fmrihrf)

# 1. Define temporal structure
sframe <- sampling_frame(blocklens = c(150, 150), TR = 2)

# 2. Create trial data (run-relative onsets)
trials <- data.frame(
  onset = c(10, 30, 50, 70, 90, 110,   # Run 1
            10, 30, 50, 70, 90, 110),   # Run 2
  run = rep(1:2, each = 6)
)

# 3. Build event model with trialwise
emod <- event_model(
  onset ~ trialwise(basis = "spmg1"),
  data = trials,
  block = ~run,
  sampling_frame = sframe
)

# 4. Build baseline model
motion <- list(
  matrix(rnorm(150 * 6), 150, 6),  # Run 1: 6 motion params
  matrix(rnorm(150 * 6), 150, 6)   # Run 2: 6 motion params
)
bmodel <- baseline_model(
  basis = "bs",
  degree = 5,
  sframe = sframe,
  nuisance_list = motion
)

# 5. Run LSS
Y <- matrix(rnorm(300 * 1000), 300, 1000)  # 300 scans, 1000 voxels
beta <- lss_design(Y, emod, bmodel, method = "oasis")

# Output: 12 × 1000 (12 trials, 1000 voxels)
dim(beta)
}

}
\seealso{
\code{\link{lss}} for the traditional matrix-based interface,
\code{fmridesign::event_model} for event model creation,
\code{fmridesign::baseline_model} for baseline model creation
}
