% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sbhm_match.R
\name{sbhm_match}
\alias{sbhm_match}
\title{Match Voxels to Library HRFs in Shared Basis (SBHM)}
\usage{
sbhm_match(
  beta_bar,
  S,
  A,
  shrink = list(tau = 0, ref = NULL, snr = NULL),
  topK = 1,
  whiten = TRUE,
  orient_ref = TRUE
)
}
\arguments{
\item{beta_bar}{Numeric matrix (r×V): per-voxel coefficients from a prepass
GLM in the SBHM basis. Columns correspond to voxels.}

\item{S}{Numeric vector (length r): singular values of the library SVD.}

\item{A}{Numeric matrix (r×K): coordinates of library HRFs in SBHM basis.}

\item{shrink}{List with optional shrinkage options:
- `tau` numeric >=0: global strength (default 0, i.e., no shrinkage).
- `ref` numeric length-r vector (alpha_ref) or NULL. If NULL, uses
  the mean of A columns. Shrinkage is: beta_bar <- (1-lambda) beta_bar + lambda ref.
- `snr` optional numeric length-V estimates; if provided, per-voxel
  lambda_v = tau/(snr_v + tau). Otherwise lambda = tau.}

\item{topK}{Integer, return top-K scores/weights if >1 (default 1).}

\item{whiten}{Logical, divide coefficients by S before normalization (default TRUE).}

\item{orient_ref}{Logical, flip beta_bar columns when their dot with `ref` is
negative before matching (default TRUE).}
}
\value{
A list with:
  - `idx` length-V integer indices of best-matching library HRF (1..K)
  - `margin` length-V numeric: score(top1) - score(top2)
  - `alpha_hat` r×V matrix: the selected library coordinates (unwhitened, unnormalized)
  - `scores` optional K×V cosine score matrix (returned when topK > 1)
  - `weights` optional top-K weights per voxel (when topK > 1)
}
\description{
Given per-voxel aggregate coefficients `beta_bar` in the shared basis `B`,
and library coordinates `A`, perform shape-only matching in a whitened,
L2-normalized coefficient space (cosine similarity). Optionally apply a
simple shrinkage of `beta_bar` towards a reference coordinate before
matching, and an orientation fix.
}
\examples{
\dontrun{
  set.seed(42)
  r <- 4; K <- 12; V <- 3
  A <- matrix(rnorm(r*K), r, K)
  S <- seq(1, 0.2, length.out = r)
  alpha2 <- A[,2]
  beta_bar <- cbind(alpha2 + rnorm(r, sd = 0.1),
                    A[,7] + rnorm(r, sd = 0.1),
                    A[,10] + rnorm(r, sd = 0.1))
  m <- sbhm_match(beta_bar, S, A)
  m$idx
}

}
