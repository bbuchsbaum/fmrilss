<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Shared-Basis HRF Matching (SBHM): Efficient Voxel-Specific HRF Estimation • fmrilss</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Shared-Basis HRF Matching (SBHM): Efficient Voxel-Specific HRF Estimation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmrilss</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting_started.html">Getting Started with fmrilss</a></li>
    <li><a class="dropdown-item" href="../articles/oasis_method.html">The OASIS Method: Optimized Analytic Single-pass Inverse Solution</a></li>
    <li><a class="dropdown-item" href="../articles/oasis_theory.html">OASIS Theory: Algebra and Implementation Details</a></li>
    <li><a class="dropdown-item" href="../articles/sbhm.html">Shared-Basis HRF Matching (SBHM): Efficient Voxel-Specific HRF Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/voxel-wise-hrf.html">Voxel-wise HRF Modeling with fmrilss</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Shared-Basis HRF Matching (SBHM): Efficient Voxel-Specific HRF Estimation</h1>
                        <h4 data-toc-skip class="author">fmrilss
Development Team</h4>
            
            <h4 data-toc-skip class="date">2025-10-31</h4>
      

      <div class="d-none name"><code>sbhm.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Shared-Basis HRF Matching (SBHM) provides an efficient middle ground
between global HRF selection (one HRF for all voxels) and fully
unconstrained voxel-wise HRF estimation. SBHM learns a low-rank shared
time basis from a library of candidate HRFs, then matches each voxel to
its best-fitting library member in a reduced coefficient space.</p>
<div class="section level3">
<h3 id="the-problem-voxel-specific-hrfs-at-scale">The Problem: Voxel-Specific HRFs at Scale<a class="anchor" aria-label="anchor" href="#the-problem-voxel-specific-hrfs-at-scale"></a>
</h3>
<p>Real fMRI data shows substantial HRF variability across brain regions
and individuals. A single canonical HRF (like SPM’s double-gamma) often
provides a poor fit to the data. However, estimating completely
unconstrained voxel-wise HRFs using FIR bases or multi-basis models
is:</p>
<ul>
<li>
<strong>Computationally expensive</strong>: Requires fitting many
parameters per voxel</li>
<li>
<strong>Data hungry</strong>: Needs many trials for stable
estimates</li>
<li>
<strong>High variance</strong>: Individual voxel estimates can be
noisy without regularization</li>
</ul>
</div>
<div class="section level3">
<h3 id="the-sbhm-solution">The SBHM Solution<a class="anchor" aria-label="anchor" href="#the-sbhm-solution"></a>
</h3>
<p>SBHM addresses these challenges by:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Learning a shared basis</strong> from a library of
physiologically plausible HRFs via SVD</li>
<li>
<strong>Fitting voxels</strong> in the low-dimensional basis space
(typically r=4-8 dimensions)</li>
<li>
<strong>Matching</strong> each voxel to its closest library member
using cosine similarity</li>
<li>
<strong>Projecting</strong> trial-wise coefficients onto matched
coordinates for interpretable amplitudes</li>
</ol>
<p>This approach provides: - <strong>Efficiency</strong>: Fit only r
parameters per voxel (vs. K×trials for FIR) -
<strong>Stability</strong>: Constrain estimates to a learned manifold of
plausible HRFs - <strong>Interpretability</strong>: Each voxel maps to a
specific library HRF with known parameters</p>
</div>
<div class="section level3">
<h3 id="when-to-use-sbhm">When to Use SBHM<a class="anchor" aria-label="anchor" href="#when-to-use-sbhm"></a>
</h3>
<p><strong>Use SBHM when:</strong> - You expect voxel-specific HRF
shapes but want them library-constrained - Your library is large
(50-200+ candidate HRFs) covering physiological variability - You want
computational efficiency with interpretable per-voxel HRF assignments -
You need to compare HRF parameters across voxels or conditions</p>
<p><strong>Use global HRF selection when:</strong> - A single shared HRF
is sufficient for your analysis - Maximum computational efficiency is
critical - Your ROI is anatomically homogeneous</p>
<p><strong>Use unconstrained voxel-wise HRF when:</strong> - You need to
discover completely novel HRF shapes - You have many trials and can
afford the variance - You want data-driven HRF discovery without
parametric constraints</p>
<p><strong>Use multi-basis or FIR when:</strong> - You need to capture
timing/shape variability within single trials - Your experimental design
varies trial-to-trial (e.g., parametric modulation)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/" class="external-link">fmrihrf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrilss/">fmrilss</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Derived convenience defaults for examples</span></span>
<span><span class="va">n_voxels_default</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fast_mode</span><span class="op">)</span> <span class="fl">20</span> <span class="kw">else</span> <span class="fl">50</span></span>
<span><span class="va">n_trials_default</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fast_mode</span><span class="op">)</span> <span class="fl">6</span> <span class="kw">else</span> <span class="fl">10</span></span>
<span><span class="va">ranks_default</span>    <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fast_mode</span><span class="op">)</span> <span class="fl">2</span><span class="op">:</span><span class="fl">6</span> <span class="kw">else</span> <span class="fl">2</span><span class="op">:</span><span class="fl">10</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="sbhm-workflow-overview">SBHM Workflow Overview<a class="anchor" aria-label="anchor" href="#sbhm-workflow-overview"></a>
</h2>
<p>The SBHM pipeline consists of four main steps, coordinated by the
<code>lss_sbhm()</code> function:</p>
<pre><code>1. sbhm_build()    → Learn shared basis B from HRF library via SVD
                     Returns: B (time basis), S (singular values), A (library coordinates)

2. sbhm_prepass()  → Fit aggregate model in basis space per voxel
                     Returns: beta_bar (r×V coefficients)

3. sbhm_match()    → Match voxels to library via cosine similarity
                     Returns: matched_idx, margin, alpha_hat

4. LSS + Project   → Run OASIS with K=r, project to scalar amplitudes
                     Returns: trial-wise amplitudes (ntrials×V)</code></pre>
<p>We’ll walk through each step with examples, then show the end-to-end
workflow.</p>
</div>
<div class="section level2">
<h2 id="step-1-building-the-shared-basis">Step 1: Building the Shared Basis<a class="anchor" aria-label="anchor" href="#step-1-building-the-shared-basis"></a>
</h2>
<p>The first step is to create a library of candidate HRFs spanning
physiological variability, then learn a low-rank basis via SVD.</p>
<div class="section level3">
<h3 id="creating-an-hrf-library">Creating an HRF Library<a class="anchor" aria-label="anchor" href="#creating-an-hrf-library"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a parameter grid for gamma HRFs</span></span>
<span><span class="co"># Shape controls peak time, rate controls width</span></span>
<span><span class="va">shapes</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fast_mode</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">10</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">11</span>, by <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">rates</span>  <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fast_mode</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">1.2</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">1.3</span>, by <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span></span>
<span><span class="va">param_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">shapes</span>, rate <span class="op">=</span> <span class="va">rates</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Library size:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">param_grid</span><span class="op">)</span>, <span class="st">"HRFs\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Library size: 9 HRFs</span></span>
<span></span>
<span><span class="co"># Function to create gamma HRF with given parameters</span></span>
<span><span class="va">gamma_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">shape</span>, <span class="va">rate</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Important: close over parameters so evaluation uses (shape, rate)</span></span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/hrf_gamma.html" class="external-link">hrf_gamma</a></span><span class="op">(</span><span class="va">t</span>, shape <span class="op">=</span> <span class="va">shape</span>, rate <span class="op">=</span> <span class="va">rate</span><span class="op">)</span></span>
<span>  <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/as_hrf.html" class="external-link">as_hrf</a></span><span class="op">(</span><span class="va">f</span>, name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"gamma(s=%.2f,r=%.2f)"</span>, <span class="va">shape</span>, <span class="va">rate</span><span class="op">)</span>, span <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Set up time grid</span></span>
<span><span class="va">sframe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="va">n_time</span>, TR <span class="op">=</span> <span class="va">TR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build SBHM with rank r=6</span></span>
<span><span class="va">sbhm</span> <span class="op">&lt;-</span> <span class="fu">sbhm_build</span><span class="op">(</span></span>
<span>  library_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    fun <span class="op">=</span> <span class="va">gamma_fun</span>,</span>
<span>    pgrid <span class="op">=</span> <span class="va">param_grid</span>,</span>
<span>    span <span class="op">=</span> <span class="fl">32</span>,           <span class="co"># HRF duration in seconds</span></span>
<span>    precision <span class="op">=</span> <span class="fl">0.1</span>,     <span class="co"># Time resolution for evaluation (0.1s steps)</span></span>
<span>    method <span class="op">=</span> <span class="st">"conv"</span>      <span class="co"># Convolution method (vs. "interp")</span></span>
<span>  <span class="op">)</span>,</span>
<span>  r <span class="op">=</span> <span class="fl">6</span>,                 <span class="co"># Target rank (number of basis functions)</span></span>
<span>  sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>  baseline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>,  <span class="co"># Remove mean in first 0.5s (before response)</span></span>
<span>  normalize <span class="op">=</span> <span class="cn">TRUE</span>,      <span class="co"># L2 normalize library columns before SVD</span></span>
<span>  shifts <span class="op">=</span> <span class="cn">NULL</span>,         <span class="co"># Optional: time shifts to augment library (experimental)</span></span>
<span>  ref <span class="op">=</span> <span class="st">"mean"</span>           <span class="co"># Reference HRF: "mean" (library average) or "spmg1" (SPM canonical)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nSBHM basis dimensions:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SBHM basis dimensions:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  B (time basis):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">B</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   B (time basis): 160 6</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  S (singular values):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">S</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   S (singular values): 6</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  A (library coords):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">A</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   A (library coords): 6 9</span></span>
<span></span>
<span><span class="co"># Estimate total library variance via a higher-rank SVD for a more meaningful percent</span></span>
<span><span class="va">max_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">12</span>, <span class="va">n_time</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">A</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sbhm_full</span> <span class="op">&lt;-</span> <span class="fu">sbhm_build</span><span class="op">(</span></span>
<span>  library_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">gamma_fun</span>, pgrid <span class="op">=</span> <span class="va">param_grid</span>, span <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>,</span>
<span>  r <span class="op">=</span> <span class="va">max_r</span>,</span>
<span>  sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>  baseline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  normalize <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Variance explained by r=6:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">S</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sbhm_full</span><span class="op">$</span><span class="va">S</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Variance explained by r=6: 100 %</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-the-learned-basis">Visualizing the Learned Basis<a class="anchor" aria-label="anchor" href="#visualizing-the-learned-basis"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the learned time basis functions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">B</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">tgrid</span>, <span class="va">sbhm</span><span class="op">$</span><span class="va">B</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"navy"</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Basis "</span>, <span class="va">i</span>, <span class="st">" (σ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">S</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>       xlab <span class="op">=</span> <span class="st">"Time (s)"</span>, ylab <span class="op">=</span> <span class="st">"Amplitude"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"gray"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="sbhm_files/figure-html/visualize-basis-1.png" width="1500"></p>
</div>
<div class="section level3">
<h3 id="understanding-the-basis">Understanding the Basis<a class="anchor" aria-label="anchor" href="#understanding-the-basis"></a>
</h3>
<p>The basis functions capture the principal modes of variation in the
HRF library:</p>
<ul>
<li>
<strong>Basis 1</strong> typically captures the main hemodynamic
response shape</li>
<li>
<strong>Basis 2-3</strong> capture timing variations (earlier
vs. later peaks)</li>
<li>
<strong>Basis 4-6</strong> capture width and undershoot
variations</li>
</ul>
<p>The singular values (S) indicate the importance of each basis
function. A rapid drop-off suggests redundancy in the library.</p>
</div>
<div class="section level3">
<h3 id="choosing-the-rank-r">Choosing the Rank (r)<a class="anchor" aria-label="anchor" href="#choosing-the-rank-r"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build SBHM with different ranks to see variance explained</span></span>
<span><span class="va">ranks</span> <span class="op">&lt;-</span> <span class="va">ranks_default</span></span>
<span><span class="va">var_explained</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ranks</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">ranks</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sbhm_test</span> <span class="op">&lt;-</span> <span class="fu">sbhm_build</span><span class="op">(</span></span>
<span>    library_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">gamma_fun</span>, pgrid <span class="op">=</span> <span class="va">param_grid</span>, span <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>,</span>
<span>    r <span class="op">=</span> <span class="va">ranks</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>    normalize <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">var_explained</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sbhm_test</span><span class="op">$</span><span class="va">S</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ranks</span>, <span class="va">var_explained</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">var_explained</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"b"</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"navy"</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Rank (r)"</span>, ylab <span class="op">=</span> <span class="st">"Variance Explained (%)"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Choosing SBHM Rank"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">95</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">97</span>, <span class="st">"95% threshold"</span>, col <span class="op">=</span> <span class="st">"red"</span>, pos <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="sbhm_files/figure-html/choose-rank-1.png" width="1200"></p>
</div>
<div class="section level3">
<h3 id="library-coverage-intuition">Library Coverage Intuition<a class="anchor" aria-label="anchor" href="#library-coverage-intuition"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize a subset of library shapes reconstructed from B and A</span></span>
<span><span class="va">H_hat</span> <span class="op">&lt;-</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">B</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">sbhm</span><span class="op">$</span><span class="va">A</span>  <span class="co"># T×K (rank-r reconstruction)</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">H_hat</span><span class="op">)</span></span>
<span><span class="va">sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">K</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">K</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">tgrid</span>, <span class="va">H_hat</span><span class="op">[</span>, <span class="va">sel</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#6baed6"</span>, <span class="st">"#08519c"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sel</span><span class="op">)</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Time (s)"</span>, ylab <span class="op">=</span> <span class="st">"Amplitude"</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"Sample of Library HRFs (rank-r reconstruction)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"gray80"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="sbhm_files/figure-html/library-coverage-1.png" width="1200"></p>
<p><strong>Guidelines for choosing r:</strong> - Start with r=6 for
gamma libraries, r=8-10 for more complex libraries - Aim for 90-95%
variance explained - Balance: larger r = better library coverage, but
more parameters to fit - Typical range: r=4 (simple) to r=12
(complex)</p>
</div>
<div class="section level3">
<h3 id="understanding-the-reference-hrf">Understanding the Reference HRF<a class="anchor" aria-label="anchor" href="#understanding-the-reference-hrf"></a>
</h3>
<p>The <code>ref</code> parameter in <code>sbhm_build()</code>
determines the reference HRF used for: 1. <strong>Shrinkage
target</strong> in matching (pulls noisy estimates towards reference) 2.
<strong>Orientation alignment</strong> via <code>orient_ref</code>
(flips coefficients to match reference polarity)</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Option 1: Mean of library (default, data-driven)</span></span>
<span><span class="va">sbhm_mean</span> <span class="op">&lt;-</span> <span class="fu">sbhm_build</span><span class="op">(</span><span class="va">...</span>, ref <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="co"># Reference = average of all library HRFs</span></span>
<span></span>
<span><span class="co"># Option 2: SPM canonical HRF (theory-driven)</span></span>
<span><span class="va">sbhm_spm</span> <span class="op">&lt;-</span> <span class="fu">sbhm_build</span><span class="op">(</span><span class="va">...</span>, ref <span class="op">=</span> <span class="st">"spmg1"</span><span class="op">)</span></span>
<span><span class="co"># Reference = SPM's double-gamma canonical HRF</span></span></code></pre></div>
<p><strong>When to use each:</strong> - <strong>“mean”</strong>
(recommended): Let your library define the typical response -
<strong>“spmg1”</strong>: For compatibility with SPM analyses or when
library is exploratory</p>
<p>The reference is stored in <code>sbhm$ref$alpha_ref</code>
(r-dimensional coordinates).</p>
</div>
</div>
<div class="section level2">
<h2 id="step-2-generating-synthetic-data-with-known-hrf-variation">Step 2: Generating Synthetic Data with Known HRF Variation<a class="anchor" aria-label="anchor" href="#step-2-generating-synthetic-data-with-known-hrf-variation"></a>
</h2>
<p>To demonstrate SBHM’s ability to recover voxel-specific HRFs, we’ll
create synthetic data where different voxels have different HRF shapes
from our library.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Experimental design</span></span>
<span><span class="va">n_voxels</span> <span class="op">&lt;-</span> <span class="va">n_voxels_default</span></span>
<span><span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="va">n_trials_default</span></span>
<span><span class="co"># Place trial onsets safely within the acquisition window so HRFs are observed</span></span>
<span><span class="va">safe_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">tgrid</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span>  <span class="co"># leave HRF span margin (~30s)</span></span>
<span><span class="va">onsets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">20</span>, <span class="va">safe_end</span>, length.out <span class="op">=</span> <span class="va">n_trials</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign each voxel a random HRF from the library</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">true_hrf_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">A</span><span class="op">)</span>, <span class="va">n_voxels</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate trial-wise design using SBHM basis</span></span>
<span><span class="va">design_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>  cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, duration <span class="op">=</span> <span class="fl">0</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">hrf_B</span> <span class="op">&lt;-</span> <span class="fu">sbhm_hrf</span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">B</span>, <span class="va">sbhm</span><span class="op">$</span><span class="va">tgrid</span>, <span class="va">sbhm</span><span class="op">$</span><span class="va">span</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor.html" class="external-link">regressor</a></span><span class="op">(</span></span>
<span>  onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>  hrf <span class="op">=</span> <span class="va">hrf_B</span>,</span>
<span>  duration <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  span <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  summate <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Build per-trial regressors explicitly (one K-column block per trial)</span></span>
<span><span class="va">regressors_by_trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="va">n_trials</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_trials</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rr_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor.html" class="external-link">regressor</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, hrf <span class="op">=</span> <span class="va">hrf_B</span>, duration <span class="op">=</span> <span class="fl">0</span>, span <span class="op">=</span> <span class="fl">30</span>, summate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">X_t</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">rr_t</span>, grid <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">tgrid</span>, precision <span class="op">=</span> <span class="fl">0.1</span>, method <span class="op">=</span> <span class="st">"conv"</span><span class="op">)</span></span>
<span>  <span class="va">regressors_by_trial</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">X_t</span>  <span class="co"># T×K</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create signal: each voxel uses its assigned HRF's coordinates</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_time</span> <span class="op">*</span> <span class="va">n_voxels</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, <span class="va">n_time</span>, <span class="va">n_voxels</span><span class="op">)</span></span>
<span><span class="va">true_amplitudes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_trials</span> <span class="op">*</span> <span class="va">n_voxels</span>, mean <span class="op">=</span> <span class="fl">2</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                          <span class="va">n_trials</span>, <span class="va">n_voxels</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">v</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_voxels</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get the true HRF coordinates for this voxel</span></span>
<span>  <span class="va">alpha_true</span> <span class="op">&lt;-</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">A</span><span class="op">[</span>, <span class="va">true_hrf_idx</span><span class="op">[</span><span class="va">v</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Add signal: X_trials * alpha_true gives the per-trial regressors</span></span>
<span>  <span class="co"># Each trial's amplitude scales this regressor</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_trials</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">regressor_t</span> <span class="op">&lt;-</span> <span class="va">regressors_by_trial</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">alpha_true</span></span>
<span>    <span class="va">Y</span><span class="op">[</span>, <span class="va">v</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Y</span><span class="op">[</span>, <span class="va">v</span><span class="op">]</span> <span class="op">+</span> <span class="va">true_amplitudes</span><span class="op">[</span><span class="va">t</span>, <span class="va">v</span><span class="op">]</span> <span class="op">*</span> <span class="va">regressor_t</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Data generated:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Data generated:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Y dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Y dimensions: 160 20</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  True HRF assignments:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">true_hrf_idx</span><span class="op">)</span><span class="op">)</span>, <span class="st">"unique HRFs\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   True HRF assignments: 9 unique HRFs</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-3-running-the-complete-sbhm-pipeline">Step 3: Running the Complete SBHM Pipeline<a class="anchor" aria-label="anchor" href="#step-3-running-the-complete-sbhm-pipeline"></a>
</h2>
<p>Now we’ll use <code>lss_sbhm()</code> to recover the voxel-specific
HRFs and trial amplitudes.</p>
<div class="section level3">
<h3 id="prewhitening-for-autocorrelated-noise">Prewhitening for Autocorrelated Noise<a class="anchor" aria-label="anchor" href="#prewhitening-for-autocorrelated-noise"></a>
</h3>
<p>If your fMRI data has temporally correlated noise (common with short
TR &lt; 2s), prewhitening improves parameter estimates:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example with AR(1) prewhitening via fmriAR</span></span>
<span><span class="va">res_prewhiten</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>, sbhm <span class="op">=</span> <span class="va">sbhm</span>, design_spec <span class="op">=</span> <span class="va">design_spec</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"ar"</span>, p <span class="op">=</span> <span class="fl">1L</span>, pooling <span class="op">=</span> <span class="st">"global"</span>, exact_first <span class="op">=</span> <span class="st">"ar1"</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>When to use prewhitening:</strong> - TR &lt; 2s (high
temporal resolution) - Visual inspection shows autocorrelated residuals
- Improved model fit is critical (e.g., single-subject studies)</p>
<p><strong>Note:</strong> Prewhitening is applied during the prepass
stage. It cannot be combined with <code>data_fac</code> (PCA
factorization).</p>
</div>
<div class="section level3">
<h3 id="basic-sbhm-run">Basic SBHM Run<a class="anchor" aria-label="anchor" href="#basic-sbhm-run"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run end-to-end SBHM (no prewhitening for this synthetic example)</span></span>
<span><span class="va">res_sbhm</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  sbhm <span class="op">=</span> <span class="va">sbhm</span>,</span>
<span>  design_spec <span class="op">=</span> <span class="va">design_spec</span>,</span>
<span>  Nuisance <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># Set to list(method="ar", p=1L, exact_first="ar1") for short TR</span></span>
<span>  prepass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    ridge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"fractional"</span>, lambda <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>  <span class="co"># Small ridge for stability</span></span>
<span>  <span class="op">)</span>,</span>
<span>  match <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    shrink <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="fl">0</span>, ref <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">ref</span><span class="op">$</span><span class="va">alpha_ref</span><span class="op">)</span>,</span>
<span>    topK <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    whiten <span class="op">=</span> <span class="cn">TRUE</span>,      <span class="co"># Whiten by singular values before matching</span></span>
<span>    orient_ref <span class="op">=</span> <span class="cn">TRUE</span>   <span class="co"># Flip coefficient sign if anti-correlated with reference</span></span>
<span>                        <span class="co"># Ensures consistent polarity across voxels</span></span>
<span>  <span class="op">)</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,  <span class="co"># Scale ridge by mean eigenvalue (recommended)</span></span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.01</span>,   <span class="co"># Regularize design matrix (X'X + ridge_x*I) for stability</span></span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.01</span>    <span class="co"># Shrink coefficients towards zero for variance reduction</span></span>
<span>  <span class="op">)</span>,</span>
<span>  return <span class="op">=</span> <span class="st">"both"</span>  <span class="co"># Return both amplitudes and coefficients</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"SBHM results:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; SBHM results:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Amplitude dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Amplitude dimensions: 6 20</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Coefficients dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">coeffs_r</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Coefficients dimensions: 6 6 20</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Matched HRF indices:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">matched_idx</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Matched HRF indices: 20</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="step-4-evaluating-hrf-recovery">Step 4: Evaluating HRF Recovery<a class="anchor" aria-label="anchor" href="#step-4-evaluating-hrf-recovery"></a>
</h2>
<p>Let’s assess how well SBHM recovered the true HRF assignments.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check matching accuracy</span></span>
<span><span class="va">matched_idx</span> <span class="op">&lt;-</span> <span class="va">res_sbhm</span><span class="op">$</span><span class="va">matched_idx</span></span>
<span><span class="va">accuracy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">matched_idx</span> <span class="op">==</span> <span class="va">true_hrf_idx</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"HRF Matching Accuracy:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">accuracy</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; HRF Matching Accuracy: 15 %</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Confused voxels:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">matched_idx</span> <span class="op">!=</span> <span class="va">true_hrf_idx</span><span class="op">)</span>, <span class="st">"/"</span>, <span class="va">n_voxels</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Confused voxels: 17 / 20</span></span>
<span></span>
<span><span class="co"># Analyze matching confidence via margin (top1 - top2 score)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matching confidence (margin):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Matching confidence (margin):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean: 0.21</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Median:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Median: 0.2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Range:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Range: 0.002 0.317</span></span>
<span></span>
<span><span class="co"># Low margin indicates ambiguity</span></span>
<span><span class="va">low_confidence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Low-confidence voxels (&lt;median):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">low_confidence</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Low-confidence voxels (&lt;median): 10</span></span></code></pre></div>
<div class="section level3">
<h3 id="visualizing-matching-confidence">Visualizing Matching Confidence<a class="anchor" aria-label="anchor" href="#visualizing-matching-confidence"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span>, breaks <span class="op">=</span> <span class="fl">20</span>, col <span class="op">=</span> <span class="st">"skyblue"</span>, border <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Distribution of Matching Confidence (Margin)"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Margin (Top1 - Top2 cosine score)"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Number of Voxels"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="st">"usr"</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">*</span> <span class="fl">0.9</span>,</span>
<span>     <span class="st">"Median"</span>, pos <span class="op">=</span> <span class="fl">4</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="sbhm_files/figure-html/visualize-margin-1.png" width="1200"></p>
<p><strong>Interpreting margin:</strong> - <strong>High margin
(&gt;0.1)</strong>: Clear winner, high confidence - <strong>Medium
margin (0.05-0.1)</strong>: Moderate confidence, top 2 candidates
similar - <strong>Low margin (&lt;0.05)</strong>: Ambiguous, consider
averaging top-K candidates</p>
<p>Note on top-K: <code>lss_sbhm()</code> uses hard assignment (top-1)
internally. For soft assignment, call <code>sbhm_prepass()</code> and
<code>sbhm_match(topK = K)</code> directly to obtain
<code>weights</code> and <code>topK_idx</code>, then combine candidate
coordinates manually before projecting via
<code>sbhm_project()</code>.</p>
</div>
<div class="section level3">
<h3 id="comparing-recovered-vs--true-amplitudes">Comparing Recovered vs. True Amplitudes<a class="anchor" aria-label="anchor" href="#comparing-recovered-vs--true-amplitudes"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Correlation between estimated and true amplitudes</span></span>
<span><span class="va">cor_amp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">true_amplitudes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">true_amplitudes</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span>,</span>
<span>     pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="st">"navy"</span>, alpha.f <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"True Amplitude"</span>, ylab <span class="op">=</span> <span class="st">"SBHM Estimated Amplitude"</span>,</span>
<span>     main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Amplitude Recovery (r = "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cor_amp</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="sbhm_files/figure-html/compare-amplitudes-1.png" width="1200"></p>
</div>
<div class="section level3">
<h3 id="library-manifold-and-matches">Library Manifold and Matches<a class="anchor" aria-label="anchor" href="#library-manifold-and-matches"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PCA of library coordinates (columns of A), overlay matched HRFs</span></span>
<span><span class="va">A_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">A</span><span class="op">)</span>  <span class="co"># K×r</span></span>
<span><span class="va">pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">A_t</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, scale. <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pc</span> <span class="op">&lt;-</span> <span class="va">pca</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pc</span>, pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"gray70"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"PC1"</span>, ylab <span class="op">=</span> <span class="st">"PC2"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Library Coordinate Space (PCA)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Highlight true and matched HRFs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">pc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">true_hrf_idx</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#2c7fb8"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">pc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">matched_idx</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">4</span>, col <span class="op">=</span> <span class="st">"#d95f02"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, bty <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Library"</span>, <span class="st">"True HRFs"</span>, <span class="st">"Matched HRFs"</span><span class="op">)</span>,</span>
<span>        pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray60"</span>, <span class="st">"#2c7fb8"</span>, <span class="st">"#d95f02"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="sbhm_files/figure-html/pca-library-1.png" width="1200"></p>
</div>
<div class="section level3">
<h3 id="matched-vs--true-hrf-shapes">Matched vs. True HRF Shapes<a class="anchor" aria-label="anchor" href="#matched-vs--true-hrf-shapes"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare matched HRF shapes to true HRFs for a few voxels</span></span>
<span><span class="va">H_hat</span> <span class="op">&lt;-</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">B</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">sbhm</span><span class="op">$</span><span class="va">A</span></span>
<span><span class="va">vox_show</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">6</span>, <span class="va">n_voxels</span><span class="op">)</span><span class="op">)</span>  <span class="co"># confident voxels</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">v</span> <span class="kw">in</span> <span class="va">vox_show</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">h_true</span> <span class="op">&lt;-</span> <span class="va">H_hat</span><span class="op">[</span>, <span class="va">true_hrf_idx</span><span class="op">[</span><span class="va">v</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">h_match</span> <span class="op">&lt;-</span> <span class="va">H_hat</span><span class="op">[</span>, <span class="va">res_sbhm</span><span class="op">$</span><span class="va">matched_idx</span><span class="op">[</span><span class="va">v</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">rng</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">h_true</span>, <span class="va">h_match</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">tgrid</span>, <span class="va">h_true</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"#2c7fb8"</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Voxel "</span>, <span class="va">v</span>, <span class="st">" (margin="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">[</span><span class="va">v</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>       xlab <span class="op">=</span> <span class="st">"Time (s)"</span>, ylab <span class="op">=</span> <span class="st">"HRF"</span>, ylim <span class="op">=</span> <span class="va">rng</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">tgrid</span>, <span class="va">h_match</span>, col <span class="op">=</span> <span class="st">"#d95f02"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"gray80"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, bty <span class="op">=</span> <span class="st">"n"</span>, cex <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>         legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"True"</span>, <span class="st">"Matched"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>         col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#2c7fb8"</span>, <span class="st">"#d95f02"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="sbhm_files/figure-html/matched-vs-true-1.png" width="1500"></p>
</div>
</div>
<div class="section level2">
<h2 id="understanding-sbhm-parameters">Understanding SBHM Parameters<a class="anchor" aria-label="anchor" href="#understanding-sbhm-parameters"></a>
</h2>
<div class="section level3">
<h3 id="parameter-quick-reference">Parameter Quick Reference<a class="anchor" aria-label="anchor" href="#parameter-quick-reference"></a>
</h3>
<p>This table summarizes all SBHM parameters with recommended starting
values:</p>
<table class="table">
<colgroup>
<col width="20%">
<col width="16%">
<col width="34%">
<col width="29%">
</colgroup>
<thead><tr class="header">
<th>Parameter</th>
<th>Default</th>
<th>Recommended Range</th>
<th>When to Adjust</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>
<strong>r</strong> (rank)</td>
<td>—</td>
<td>6 (simple) to 12 (complex)</td>
<td>Aim for 90-95% variance explained</td>
</tr>
<tr class="even">
<td>
<strong>topK</strong> (matching)</td>
<td>1</td>
<td>1 (hard) to 5 (soft)</td>
<td>Use 3-5 for ambiguous cases</td>
</tr>
<tr class="odd">
<td>
<strong>ridge.lambda</strong> (prepass)</td>
<td>0.01</td>
<td>0.005 to 0.05</td>
<td>Add 0.01-0.05 for noisy data</td>
</tr>
<tr class="even">
<td><strong>ridge.mode</strong></td>
<td>“fractional”</td>
<td>“fractional” or “absolute”</td>
<td>Fractional scales by design energy</td>
</tr>
<tr class="odd">
<td>
<strong>shrink.tau</strong> (matching)</td>
<td>0</td>
<td>0 to 0.2</td>
<td>Increase for low SNR (0.1-0.2)</td>
</tr>
<tr class="even">
<td><strong>whiten</strong></td>
<td>TRUE</td>
<td>TRUE (recommended)</td>
<td>Set FALSE to weight by singular values</td>
</tr>
<tr class="odd">
<td><strong>orient_ref</strong></td>
<td>TRUE</td>
<td>TRUE (recommended)</td>
<td>Ensures consistent coefficient polarity</td>
</tr>
<tr class="even">
<td>
<strong>ridge_x</strong> (OASIS design)</td>
<td>0</td>
<td>0.01 to 0.05</td>
<td>Increase if design ill-conditioned</td>
</tr>
<tr class="odd">
<td>
<strong>ridge_b</strong> (OASIS coeffs)</td>
<td>0</td>
<td>0.01 to 0.05</td>
<td>Increase for variance reduction</td>
</tr>
<tr class="even">
<td><strong>prewhiten</strong></td>
<td>NULL</td>
<td>NULL or list(method=“ar”, p=1L)</td>
<td>Use for TR &lt; 2s or autocorrelated noise</td>
</tr>
<tr class="odd">
<td><strong>data_fac</strong></td>
<td>NULL</td>
<td>NULL or PCA factorization</td>
<td>Use for V &gt; 50,000 voxels</td>
</tr>
</tbody>
</table>
<p><strong>Minimal call</strong> (uses all defaults except required
arguments):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, sbhm <span class="op">=</span> <span class="va">sbhm</span>, design_spec <span class="op">=</span> <span class="va">design_spec</span><span class="op">)</span></span>
<span><span class="co"># Uses: small fractional ridge (0.01), topK=1, whiten=TRUE, orient_ref=TRUE, no prewhitening</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prepass-ridge-regularization">Prepass Ridge Regularization<a class="anchor" aria-label="anchor" href="#prepass-ridge-regularization"></a>
</h3>
<p>The prepass fits aggregate coefficients per voxel. Ridge helps with:
- Collinear basis functions (if library has redundancy) - Low SNR data -
Preventing extreme coefficients</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: varying ridge strength</span></span>
<span><span class="va">prepass</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  ridge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mode <span class="op">=</span> <span class="st">"fractional"</span>,    <span class="co"># Scale by design energy</span></span>
<span>    lambda <span class="op">=</span> <span class="fl">0.01</span>,          <span class="co"># 1% of mean eigenvalue</span></span>
<span>    alpha_ref <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">ref</span><span class="op">$</span><span class="va">alpha_ref</span>  <span class="co"># Shrink towards reference</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Guidelines:</strong> - Start with <code>lambda = 0.01</code>
(small fractional ridge) - Increase to <code>0.02–0.05</code> if
unstable or low SNR - Use <code>mode = "fractional"</code> for automatic
scaling by design energy</p>
</div>
<div class="section level3">
<h3 id="matching-shrinkage">Matching Shrinkage<a class="anchor" aria-label="anchor" href="#matching-shrinkage"></a>
</h3>
<p>Shrinkage pulls noisy voxel estimates towards a reference before
matching, reducing the influence of noise on HRF assignment.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">match</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  shrink <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    tau <span class="op">=</span> <span class="fl">0.1</span>,              <span class="co"># Shrinkage strength (0 = none, 1 = full shrinkage to ref)</span></span>
<span>    ref <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">ref</span><span class="op">$</span><span class="va">alpha_ref</span>,  <span class="co"># Shrinkage target (library mean by default)</span></span>
<span>    snr <span class="op">=</span> <span class="cn">NULL</span>              <span class="co"># Optional: per-voxel SNR for adaptive shrinkage</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>When to use:</strong> - Low SNR data:
<code>tau = 0.1-0.2</code> (stronger shrinkage) - High SNR data:
<code>tau = 0</code> (no shrinkage) - Adaptive shrinkage: provide
per-voxel SNR estimates</p>
<div class="section level4">
<h4 id="adaptive-shrinkage-with-snr">Adaptive Shrinkage with SNR<a class="anchor" aria-label="anchor" href="#adaptive-shrinkage-with-snr"></a>
</h4>
<p>For heterogeneous SNR across voxels, adaptive shrinkage adjusts
<code>tau</code> per voxel:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute per-voxel SNR from prepass (higher SNR = less shrinkage)</span></span>
<span><span class="co"># Simple proxy: ratio of aggregate fit variance to residual variance</span></span>
<span><span class="va">prepass_result</span> <span class="op">&lt;-</span> <span class="fu">sbhm_prepass</span><span class="op">(</span><span class="va">Y</span>, <span class="va">sbhm</span>, <span class="va">design_spec</span><span class="op">)</span></span>
<span><span class="co"># Proxy SNR: variance explained by aggregate fit vs. residual variance</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">prepass_result</span><span class="op">$</span><span class="va">A_agg</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">prepass_result</span><span class="op">$</span><span class="va">beta_bar</span>  <span class="co"># in residualized space</span></span>
<span><span class="va">signal_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="fl">2</span>, <span class="fu">stats</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">)</span></span>
<span><span class="va">total_var</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Y</span>,   <span class="fl">2</span>, <span class="fu">stats</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">)</span></span>
<span><span class="va">residual_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">total_var</span> <span class="op">-</span> <span class="va">signal_var</span>, <span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span></span>
<span><span class="va">snr_voxel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">signal_var</span>, <span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span> <span class="op">/</span> <span class="va">residual_var</span></span>
<span></span>
<span><span class="va">match</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  shrink <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    tau <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># NULL triggers adaptive mode</span></span>
<span>    ref <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">ref</span><span class="op">$</span><span class="va">alpha_ref</span>,</span>
<span>    snr <span class="op">=</span> <span class="va">snr_voxel</span>  <span class="co"># Higher SNR voxels get less shrinkage</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Adaptive formula:</strong> For voxel <em>v</em>, effective
tau = <code>base_tau / (1 + snr[v])</code>, where <code>base_tau</code>
is calibrated internally.</p>
</div>
</div>
<div class="section level3">
<h3 id="whitening">Whitening<a class="anchor" aria-label="anchor" href="#whitening"></a>
</h3>
<p>Whitening divides coefficients by singular values before matching,
equalizing the importance of all basis directions.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">match</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  whiten <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># Recommended: divides by S before L2 normalization</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Effect:</strong> Without whitening, the first basis (largest
S) dominates matching. With whitening, all r dimensions contribute
equally to the cosine score.</p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-use-cases">Advanced Use Cases<a class="anchor" aria-label="anchor" href="#advanced-use-cases"></a>
</h2>
<div class="section level3">
<h3 id="working-with-top-k-matches">Working with Top-K Matches<a class="anchor" aria-label="anchor" href="#working-with-top-k-matches"></a>
</h3>
<p>Instead of hard assignment to the single best HRF, you can get the
top-K candidates with weights.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate top-K matching directly via sbhm_prepass + sbhm_match</span></span>
<span><span class="va">pre_small</span> <span class="op">&lt;-</span> <span class="fu">sbhm_prepass</span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,  <span class="co"># Subset for speed</span></span>
<span>  sbhm <span class="op">=</span> <span class="va">sbhm</span>,</span>
<span>  design_spec <span class="op">=</span> <span class="va">design_spec</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m_top3</span> <span class="op">&lt;-</span> <span class="fu">sbhm_match</span><span class="op">(</span></span>
<span>  beta_bar <span class="op">=</span> <span class="va">pre_small</span><span class="op">$</span><span class="va">beta_bar</span>,</span>
<span>  S <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">S</span>,</span>
<span>  A <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">A</span>,</span>
<span>  topK <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  whiten <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Top-3 matching (subset):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Top-3 matching (subset):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Top indices dims:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">m_top3</span><span class="op">$</span><span class="va">topK_idx</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Top indices dims: 3 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Weights dims:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">m_top3</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Weights dims: 3 10</span></span>
<span></span>
<span><span class="co"># Examine one voxel's top-3 matches</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nVoxel"</span>, <span class="va">v</span>, <span class="st">"top-3:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Voxel 1 top-3:</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Rank"</span>, <span class="va">k</span>, <span class="st">": HRF"</span>, <span class="va">m_top3</span><span class="op">$</span><span class="va">topK_idx</span><span class="op">[</span><span class="va">k</span>, <span class="va">v</span><span class="op">]</span>,</span>
<span>      <span class="st">"(weight ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">m_top3</span><span class="op">$</span><span class="va">weights</span><span class="op">[</span><span class="va">k</span>, <span class="va">v</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">")\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;   Rank 1 : HRF 2 (weight = 0.373 )</span></span>
<span><span class="co">#&gt;   Rank 2 : HRF 5 (weight = 0.321 )</span></span>
<span><span class="co">#&gt;   Rank 3 : HRF 8 (weight = 0.307 )</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="soft-assignment-end-to-end">Soft Assignment End-to-End<a class="anchor" aria-label="anchor" href="#soft-assignment-end-to-end"></a>
</h3>
<p>Hard assignment uses only the top-1 HRF per voxel. Soft assignment
blends the top-K candidates using their softmax weights, then projects
trial-wise coefficients onto this blended coordinate to produce
amplitudes. This can reduce variance for ambiguous voxels (small margin)
at the cost of some bias.</p>
<p>Conceptually: - Prepass: estimate per-voxel basis coefficients
<code>beta_bar</code>. - Match: compute cosine scores in whitened,
L2-normalized space; convert top-K scores into softmax weights
(temperature = 1) per voxel. - Blend: compute weighted average of the
unwhitened library coordinates A[:, idx] using those weights to form
<code>alpha_soft</code> (r×V). - LSS: obtain trial-wise r-dimensional
coefficients (K=r) with OASIS. - Project: amplitudes = inner product of
trial-wise coefficients with <code>alpha_soft</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1) Prepass on all voxels</span></span>
<span><span class="va">pre_all</span> <span class="op">&lt;-</span> <span class="fu">sbhm_prepass</span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, sbhm <span class="op">=</span> <span class="va">sbhm</span>, design_spec <span class="op">=</span> <span class="va">design_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2) Top-K matching with softmax weights</span></span>
<span><span class="va">topK</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">m_soft</span> <span class="op">&lt;-</span> <span class="fu">sbhm_match</span><span class="op">(</span></span>
<span>  beta_bar <span class="op">=</span> <span class="va">pre_all</span><span class="op">$</span><span class="va">beta_bar</span>,</span>
<span>  S <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">S</span>,</span>
<span>  A <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">A</span>,</span>
<span>  topK <span class="op">=</span> <span class="va">topK</span>,</span>
<span>  whiten <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  orient_ref <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3) Build blended coordinates alpha_soft (r×V)</span></span>
<span><span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pre_all</span><span class="op">$</span><span class="va">beta_bar</span><span class="op">)</span></span>
<span><span class="va">alpha_soft</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">r</span>, ncol <span class="op">=</span> <span class="va">V</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">v</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">m_soft</span><span class="op">$</span><span class="va">topK_idx</span><span class="op">[</span>, <span class="va">v</span><span class="op">]</span></span>
<span>  <span class="va">w</span>   <span class="op">&lt;-</span> <span class="va">m_soft</span><span class="op">$</span><span class="va">weights</span><span class="op">[</span>, <span class="va">v</span><span class="op">]</span></span>
<span>  <span class="co"># Weighted combination in unwhitened coordinate space</span></span>
<span>  <span class="va">alpha_soft</span><span class="op">[</span>, <span class="va">v</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">A</span><span class="op">[</span>, <span class="va">idx</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">w</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 4) Trial-wise coefficients with OASIS (K=r)</span></span>
<span><span class="va">hrf_B</span> <span class="op">&lt;-</span> <span class="fu">sbhm_hrf</span><span class="op">(</span><span class="va">sbhm</span><span class="op">$</span><span class="va">B</span>, <span class="va">sbhm</span><span class="op">$</span><span class="va">tgrid</span>, <span class="va">sbhm</span><span class="op">$</span><span class="va">span</span><span class="op">)</span></span>
<span><span class="va">spec</span>  <span class="op">&lt;-</span> <span class="va">design_spec</span>; <span class="va">spec</span><span class="op">$</span><span class="va">cond</span><span class="op">$</span><span class="va">hrf</span> <span class="op">&lt;-</span> <span class="va">hrf_B</span></span>
<span><span class="va">BetaMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>, X <span class="op">=</span> <span class="cn">NULL</span>, Z <span class="op">=</span> <span class="cn">NULL</span>, Nuisance <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>design_spec <span class="op">=</span> <span class="va">spec</span>, K <span class="op">=</span> <span class="va">r</span><span class="op">)</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">BetaMat</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">r</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">ntrials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">BetaMat</span><span class="op">)</span> <span class="op">/</span> <span class="va">r</span></span>
<span><span class="va">beta_rt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">BetaMat</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">ntrials</span>, <span class="va">V</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5) Soft-assignment amplitudes</span></span>
<span><span class="va">amps_soft</span> <span class="op">&lt;-</span> <span class="fu">sbhm_project</span><span class="op">(</span><span class="va">beta_rt</span>, <span class="va">alpha_soft</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Soft-assignment amplitudes dims:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">amps_soft</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Soft-assignment amplitudes dims: 6 20</span></span>
<span></span>
<span><span class="co"># Optional: compare against hard-assignment amplitudes from lss_sbhm()</span></span>
<span><span class="va">res_hard</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span><span class="va">Y</span>, <span class="va">sbhm</span>, <span class="va">design_spec</span>, return <span class="op">=</span> <span class="st">"amplitude"</span>,</span>
<span>                     prepass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ridge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"fractional"</span>, lambda <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cor_soft_hard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">amps_soft</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">res_hard</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Correlation (soft vs hard amplitudes):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cor_soft_hard</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Correlation (soft vs hard amplitudes): 0.912</span></span>
<span></span>
<span><span class="co"># Focus on ambiguous voxels (low margin) where soft can help</span></span>
<span><span class="va">ambig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">res_hard</span><span class="op">$</span><span class="va">margin</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">res_hard</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ambig</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Ambiguous voxels (n):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ambig</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Ambiguous voxels (n): 10</span></span></code></pre></div>
<div class="section level4">
<h4 id="built-in-soft-assignment-convenience">Built-in Soft Assignment (Convenience)<a class="anchor" aria-label="anchor" href="#built-in-soft-assignment-convenience"></a>
</h4>
<p>For convenience, <code>lss_sbhm()</code> can also perform soft
blending internally to avoid manual steps. Set
<code>match = list(topK = 3, soft_blend = TRUE)</code> and optionally a
<code>blend_margin</code> to only blend ambiguous voxels.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_soft</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  sbhm <span class="op">=</span> <span class="va">sbhm</span>,</span>
<span>  design_spec <span class="op">=</span> <span class="va">design_spec</span>,</span>
<span>  prepass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ridge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"fractional"</span>, lambda <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  match <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>topK <span class="op">=</span> <span class="fl">3</span>, soft_blend <span class="op">=</span> <span class="cn">TRUE</span>, blend_margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">res_hard</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  return <span class="op">=</span> <span class="st">"amplitude"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cor_built</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">res_soft</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">res_hard</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Correlation (built-in soft vs hard):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cor_built</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Correlation (built-in soft vs hard): 0.96</span></span></code></pre></div>
<p>Best practices for soft assignment: - Use when <code>margin</code> is
small (ambiguous matches). Consider blending only for voxels with
<code>margin &lt; threshold</code> and keep hard assignment otherwise. -
The weights are a softmax over cosine scores (temperature = 1). To
sharpen or smooth, you can post-process scores with a custom temperature
before exponentiation. - Blending trades interpretability (single HRF
per voxel) for stability. Report both the matched index and whether soft
blending was applied.</p>
</div>
</div>
<div class="section level3">
<h3 id="returning-coefficients-for-custom-analysis">Returning Coefficients for Custom Analysis<a class="anchor" aria-label="anchor" href="#returning-coefficients-for-custom-analysis"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get trial-wise coefficients in basis space</span></span>
<span><span class="va">res_coeffs</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>  sbhm <span class="op">=</span> <span class="va">sbhm</span>,</span>
<span>  design_spec <span class="op">=</span> <span class="va">design_spec</span>,</span>
<span>  return <span class="op">=</span> <span class="st">"coefficients"</span>  <span class="co"># Don't project to amplitudes</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Coefficient array dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">res_coeffs</span><span class="op">$</span><span class="va">coeffs_r</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Coefficient array dimensions: 6 6 5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  [1] = basis dimension (r)\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1] = basis dimension (r)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  [2] = number of trials\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [2] = number of trials</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  [3] = number of voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [3] = number of voxels</span></span>
<span></span>
<span><span class="co"># You can now do custom projections or analyses in coefficient space</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="performance-considerations">Performance Considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a>
</h2>
<div class="section level3">
<h3 id="computational-cost">Computational Cost<a class="anchor" aria-label="anchor" href="#computational-cost"></a>
</h3>
<p>SBHM cost scales as: - <strong>Build:</strong> O(T²·K) for library
SVD (one-time) - <strong>Prepass:</strong> O(T²·r + T·r·V) per voxel
aggregate fit - <strong>Match:</strong> O(r·K·V) for cosine scores -
<strong>LSS:</strong> O(T·r·N·V) for N trials, r-dimensional design</p>
<p><strong>Compared to alternatives:</strong> - <strong>vs. Global grid
search:</strong> ~2-3x slower (r fits vs. 1 fit per candidate) -
<strong>vs. Voxel-wise FIR:</strong> ~10-50x faster (r parameters
vs. K·N parameters) - <strong>vs. Unconstrained per-voxel:</strong>
~5-20x faster</p>
</div>
<div class="section level3">
<h3 id="memory-usage">Memory Usage<a class="anchor" aria-label="anchor" href="#memory-usage"></a>
</h3>
<p>Peak memory scales with: - <strong>Data:</strong> T·V (input fMRI
data) - <strong>Design:</strong> T·r·N (trial-wise basis design) -
<strong>Coefficients:</strong> r·N·V (trial-wise basis coefficients)</p>
<p>For T=300, V=100k, r=6, N=100: ~2GB for coefficients.</p>
</div>
<div class="section level3">
<h3 id="optimization-tips">Optimization Tips<a class="anchor" aria-label="anchor" href="#optimization-tips"></a>
</h3>
<div class="section level4">
<h4 id="data-factorization-for-whole-brain-analysis">1. Data Factorization for Whole-Brain Analysis<a class="anchor" aria-label="anchor" href="#data-factorization-for-whole-brain-analysis"></a>
</h4>
<p>For very large datasets (V &gt; 50,000 voxels), use PCA factorization
to reduce memory and computation:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute PCA decomposition: Y ≈ scores × loadings'</span></span>
<span><span class="va">pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">Y</span>, center <span class="op">=</span> <span class="cn">TRUE</span>, rank. <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>  <span class="co"># Keep q=100 components</span></span>
<span><span class="va">Y_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  scores <span class="op">=</span> <span class="va">pca</span><span class="op">$</span><span class="va">x</span>,       <span class="co"># T×q (time × components)</span></span>
<span>  loadings <span class="op">=</span> <span class="va">pca</span><span class="op">$</span><span class="va">rotation</span>  <span class="co"># q×V (components × voxels)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run SBHM on factored data (fits q "meta-voxels" instead of V voxels)</span></span>
<span><span class="va">res_sbhm</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y_pca</span><span class="op">$</span><span class="va">scores</span>,  <span class="co"># Pass scores as Y</span></span>
<span>  sbhm <span class="op">=</span> <span class="va">sbhm</span>,</span>
<span>  design_spec <span class="op">=</span> <span class="va">design_spec</span>,</span>
<span>  prepass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    data_fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      scores <span class="op">=</span> <span class="va">Y_pca</span><span class="op">$</span><span class="va">scores</span>,    <span class="co"># T×q</span></span>
<span>      loadings <span class="op">=</span> <span class="va">Y_pca</span><span class="op">$</span><span class="va">loadings</span> <span class="co"># q×V (transposed internally)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Trade-offs:</strong> - <strong>Speedup:</strong> ~V/q times
faster prepass (e.g., 100x for V=100k, q=100) -
<strong>Accuracy:</strong> Loses information in discarded components
(minor for q=100-200) - <strong>Limitation:</strong> Cannot use with
<code>prewhiten</code> (incompatible operations)</p>
<p><strong>When to use:</strong> V &gt; 50,000 and memory is limited, or
when prepass is the bottleneck.</p>
</div>
<div class="section level4">
<h4 id="process-in-roi-chunks">2. Process in ROI Chunks<a class="anchor" aria-label="anchor" href="#process-in-roi-chunks"></a>
</h4>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For targeted analyses, process specific brain regions</span></span>
<span><span class="va">roi_mask</span> <span class="op">&lt;-</span> <span class="va">my_roi_definition</span>  <span class="co"># Logical vector</span></span>
<span><span class="va">Y_roi</span> <span class="op">&lt;-</span> <span class="va">Y</span><span class="op">[</span>, <span class="va">roi_mask</span><span class="op">]</span></span>
<span><span class="va">res_roi</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span><span class="va">Y_roi</span>, <span class="va">sbhm</span>, <span class="va">design_spec</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="reduce-library-size-if-matching-is-slow">3. Reduce Library Size if Matching is Slow<a class="anchor" aria-label="anchor" href="#reduce-library-size-if-matching-is-slow"></a>
</h4>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># SBHM matching is O(r·K·V), so K matters for large V</span></span>
<span><span class="co"># Option: Cluster library in parameter space and use centroids</span></span>
<span><span class="va">param_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">param_grid</span>, centers <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">pgrid_reduced</span> <span class="op">&lt;-</span> <span class="va">param_grid</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">param_clusters</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="library-augmentation-with-time-shifts-experimental">4. Library Augmentation with Time Shifts (Experimental)<a class="anchor" aria-label="anchor" href="#library-augmentation-with-time-shifts-experimental"></a>
</h4>
<p>The <code>shifts</code> parameter augments the library by
time-shifting each HRF:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add shifted versions of each HRF (e.g., ±1s shifts)</span></span>
<span><span class="va">sbhm_shifted</span> <span class="op">&lt;-</span> <span class="fu">sbhm_build</span><span class="op">(</span></span>
<span>  library_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">gamma_fun</span>, pgrid <span class="op">=</span> <span class="va">param_grid</span>, span <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>,</span>
<span>  r <span class="op">=</span> <span class="fl">8</span>,  <span class="co"># May need higher rank for shifted library</span></span>
<span>  sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>  shifts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,  <span class="co"># Create 3 versions: 1s early, on-time, 1s late</span></span>
<span>  normalize <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Library size increases by length(shifts) factor (K → K×3)</span></span></code></pre></div>
<p><strong>Use cases:</strong> - Uncertain event timing (e.g.,
subject-paced tasks) - Modeling temporal jitter in HRF onset -
Exploratory analyses</p>
<p><strong>Caution:</strong> Increases library size (computational cost)
and risk of overfitting.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="comparison-with-other-approaches">Comparison with Other Approaches<a class="anchor" aria-label="anchor" href="#comparison-with-other-approaches"></a>
</h2>
<div class="section level3">
<h3 id="sbhm-vs--global-hrf-selection">SBHM vs. Global HRF Selection<a class="anchor" aria-label="anchor" href="#sbhm-vs--global-hrf-selection"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Aspect</th>
<th>SBHM</th>
<th>Global Selection</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Per-voxel HRFs</td>
<td>✓ Yes</td>
<td>✗ Single shared HRF</td>
</tr>
<tr class="even">
<td>Computation</td>
<td>Moderate</td>
<td>Fast</td>
</tr>
<tr class="odd">
<td>Interpretability</td>
<td>High (library params)</td>
<td>High (single model)</td>
</tr>
<tr class="even">
<td>Flexibility</td>
<td>Library-constrained</td>
<td>Fully constrained</td>
</tr>
<tr class="odd">
<td>Best for</td>
<td>Heterogeneous regions</td>
<td>Homogeneous ROIs</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="sbhm-vs--unconstrained-voxel-wise">SBHM vs. Unconstrained Voxel-Wise<a class="anchor" aria-label="anchor" href="#sbhm-vs--unconstrained-voxel-wise"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Aspect</th>
<th>SBHM</th>
<th>Unconstrained</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Parameters/voxel</td>
<td>r (4-8)</td>
<td>K·N (50-500+)</td>
</tr>
<tr class="even">
<td>Stability</td>
<td>High (regularized)</td>
<td>Lower (needs many trials)</td>
</tr>
<tr class="odd">
<td>Interpretability</td>
<td>High (library mapping)</td>
<td>Lower (arbitrary shapes)</td>
</tr>
<tr class="even">
<td>Flexibility</td>
<td>Library-constrained</td>
<td>Fully flexible</td>
</tr>
<tr class="odd">
<td>Best for</td>
<td>Known HRF variability</td>
<td>Novel HRF discovery</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="low-matching-accuracy">Low Matching Accuracy<a class="anchor" aria-label="anchor" href="#low-matching-accuracy"></a>
</h3>
<p><strong>Symptoms:</strong> Many voxels assigned incorrect HRFs, low
correlation with ground truth</p>
<p><strong>Possible causes:</strong> 1. Library doesn’t cover the true
HRF shapes 2. Low SNR making coefficient estimates noisy 3. Insufficient
trials for stable prepass fit</p>
<p><strong>Solutions:</strong> - Expand library to cover more parameter
space - Increase shrinkage: <code>tau = 0.1-0.2</code> - Add ridge
regularization to prepass - Increase number of trials in experiment</p>
</div>
<div class="section level3">
<h3 id="high-variance-in-amplitudes">High Variance in Amplitudes<a class="anchor" aria-label="anchor" href="#high-variance-in-amplitudes"></a>
</h3>
<p><strong>Symptoms:</strong> Amplitudes have high trial-to-trial
variability, low test-retest reliability</p>
<p><strong>Possible causes:</strong> 1. Matched HRF is wrong (using
wrong projection) 2. Low SNR in data 3. Insufficient ridge in OASIS
step</p>
<p><strong>Solutions:</strong> - Check matching confidence via
<code>margin</code> - Increase OASIS ridge:
<code>ridge_x = 0.05-0.1</code> - Use top-K averaging instead of hard
assignment</p>
</div>
<div class="section level3">
<h3 id="slow-computation">Slow Computation<a class="anchor" aria-label="anchor" href="#slow-computation"></a>
</h3>
<p><strong>Symptoms:</strong> SBHM takes much longer than expected</p>
<p><strong>Possible causes:</strong> 1. Very large library (K &gt; 200)
2. High rank (r &gt; 12) with many voxels 3. Dense event designs with
many trials</p>
<p><strong>Solutions:</strong> - Reduce library size via clustering in
parameter space - Lower rank: start with r=6 - Process ROIs separately
instead of whole-brain</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Mumford et al. (2012). “Deconvolving BOLD activation in
event-related designs for multivoxel pattern classification analyses.”
<em>NeuroImage</em>.</li>
<li>Lindquist et al. (2009). “Modeling the hemodynamic response function
in fMRI.” <em>NeuroImage</em>.</li>
<li>Friston et al. (1998). “Event-related fMRI: Characterizing
differential responses.” <em>NeuroImage</em>.</li>
</ul>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>SBHM provides an efficient, interpretable approach to voxel-specific
HRF estimation by:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Learning</strong> a shared basis from a physiologically
plausible library</li>
<li>
<strong>Matching</strong> voxels to library members via cosine
similarity in coefficient space</li>
<li>
<strong>Estimating</strong> trial-wise activations with per-voxel
HRF shapes</li>
</ol>
<p><strong>Key advantages:</strong> - Computational efficiency (fit r
parameters per voxel, not K·N) - Built-in regularization via library
constraint - Interpretable HRF assignments with confidence scores -
Integrates seamlessly with OASIS LSS framework</p>
<p><strong>Next steps:</strong> - See <code>?sbhm_build</code> for
library construction details - See <code>?lss_sbhm</code> for full
parameter documentation - See the “Voxel-wise HRF” vignette for
unconstrained alternatives - See the “OASIS Method” vignette for related
approaches</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Brad Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
