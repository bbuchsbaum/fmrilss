<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The OASIS Method: Optimized Analytic Single-pass Inverse Solution • fmrilss</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The OASIS Method: Optimized Analytic Single-pass Inverse Solution">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmrilss</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting_started.html">Getting Started with fmrilss</a></li>
    <li><a class="dropdown-item" href="../articles/oasis_method.html">The OASIS Method: Optimized Analytic Single-pass Inverse Solution</a></li>
    <li><a class="dropdown-item" href="../articles/voxel-wise-hrf.html">Voxel-wise HRF Modeling with fmrilss</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>The OASIS Method: Optimized Analytic Single-pass Inverse Solution</h1>
                        <h4 data-toc-skip class="author">fmrilss
Development Team</h4>
            
            <h4 data-toc-skip class="date">2025-09-15</h4>
      

      <div class="d-none name"><code>oasis_method.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-computational-challenge-of-modern-fmri">The Computational Challenge of Modern fMRI<a class="anchor" aria-label="anchor" href="#the-computational-challenge-of-modern-fmri"></a>
</h2>
<p>Imagine you’re working with a cutting-edge fMRI dataset:
sub-millimeter resolution, thousands of trials, complex overlapping
designs, and you need trial-specific estimates for each of hundreds of
thousands of voxels. The standard LSS approach, while theoretically
sound, requires fitting separate models for each trial at each
voxel—potentially millions of model fits. With large datasets, this
computational burden becomes significant. What if there was a way to
achieve the same theoretical results more efficiently?</p>
<p>Enter OASIS—Optimized Analytic Single-pass Inverse Solution—a method
that reimagines how we compute LSS estimates. Rather than iterating
through trials one by one, OASIS leverages clever mathematical
reformulations to compute all trial estimates simultaneously in a
single, highly optimized pass. But OASIS is more than just a speed
improvement; it brings sophisticated features like automatic HRF
estimation, ridge regularization for numerical stability, and seamless
handling of multi-basis HRF models that would be cumbersome to implement
in traditional frameworks.</p>
<p>This vignette assumes you’re comfortable with the basic LSS concepts
from our getting started guide, understand HRF models and basis
functions from working with neuroimaging data, have some familiarity
with ridge regression and regularization concepts, and know the basics
of the <code>fmrihrf</code> package for HRF modeling. With this
foundation, we’ll explore how OASIS can transform your approach to
trial-wise beta estimation.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/" class="external-link">fmrihrf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'fmrihrf'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     deriv</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrilss/">fmrilss</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Helper function to create design matrix using fmrihrf API</span></span>
<span><span class="co"># (design_matrix is not exported from fmrihrf, so we create a wrapper)</span></span>
<span><span class="va">design_matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sframe</span>, <span class="va">conditions</span>, <span class="va">tr_per_trial</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Helper to safely extract condition fields without partial matching</span></span>
<span>  <span class="va">cond_field</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cond</span>, <span class="va">name</span>, <span class="va">default</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cond</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="va">cond</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="kw">else</span> <span class="va">default</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">tr_per_trial</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Create trial-wise design (one column per trial)</span></span>
<span>    <span class="va">X_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">cond</span> <span class="kw">in</span> <span class="va">conditions</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">onsets</span> <span class="op">&lt;-</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"onsets"</span><span class="op">)</span></span>
<span>      <span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">onsets</span><span class="op">)</span></span>
<span>      <span class="co"># Each trial gets its own regressor</span></span>
<span>      <span class="va">X_trial</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor_design.html" class="external-link">regressor_design</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>        fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_trials</span><span class="op">)</span><span class="op">)</span>,  <span class="co"># Each trial is its own level</span></span>
<span>        block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="va">n_trials</span><span class="op">)</span>,        <span class="co"># Assume single block for simplicity</span></span>
<span>        sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>        hrf <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"hrf"</span>, <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span><span class="op">)</span>,</span>
<span>        duration <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"duration"</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>        span <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"span"</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>        precision <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"precision"</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>        method <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"method"</span>, <span class="st">"conv"</span><span class="op">)</span>,</span>
<span>        summate <span class="op">=</span> <span class="cn">FALSE</span>  <span class="co"># Don't sum across trials</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">X_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X_list</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">X_trial</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">X_list</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Create aggregate design (one column per condition)</span></span>
<span>    <span class="va">X_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">cond</span> <span class="kw">in</span> <span class="va">conditions</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">onsets</span> <span class="op">&lt;-</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"onsets"</span><span class="op">)</span></span>
<span>      <span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">onsets</span><span class="op">)</span></span>
<span>      <span class="co"># All trials in same condition get summed</span></span>
<span>      <span class="va">X_cond</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor_design.html" class="external-link">regressor_design</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>        fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="va">n_trials</span><span class="op">)</span><span class="op">)</span>,  <span class="co"># All trials same level</span></span>
<span>        block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="va">n_trials</span><span class="op">)</span>,</span>
<span>        sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>        hrf <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"hrf"</span>, <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span><span class="op">)</span>,</span>
<span>        duration <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"duration"</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>        span <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"span"</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>        precision <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"precision"</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>        method <span class="op">=</span> <span class="fu">cond_field</span><span class="op">(</span><span class="va">cond</span>, <span class="st">"method"</span>, <span class="st">"conv"</span><span class="op">)</span>,</span>
<span>        summate <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># Sum across trials in condition</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">X_list</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">X_list</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">X_cond</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">X_list</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="understanding-the-oasis-innovation">Understanding the OASIS Innovation<a class="anchor" aria-label="anchor" href="#understanding-the-oasis-innovation"></a>
</h2>
<p>The key algebra that OASIS leverages is the special structure of LSS:
although naïvely it looks like N separate GLMs (one per trial), the
per‑trial designs share components that let you factor the computation
and reuse them across trials. Note this factoring is already exploited
by fmrilss’s optimized backends (e.g., the fused single‑pass solver that
residualizes once and reuses totals and cross‑products across trials).
OASIS uses the same core solve but wraps it in a richer, HRF-aware
workflow: automatic design construction from event specs, built-in ridge
scaling, AR(1) whitening, SE/diagnostic reporting, and native support
for multi-basis or FIR HRFs.</p>
<p>Beyond computational efficiency, OASIS adds features that the generic
LSS path does not expose: built‑in ridge regularization (absolute and
fractional) on the two‑regressor Gram per trial, optional AR(1)
whitening, analytical standard errors and diagnostics, and a blocked
multi‑basis solver that treats K&gt;1 HRF bases as 2K×2K closed‑form
systems per trial.</p>
<p>Finally, OASIS integrates directly with fmrihrf: it builds trial‑wise
designs from event specs (including multi‑condition aggregates),
auto‑detects basis dimension K, supports FIR/non‑parametric bases, and
can run fast HRF grid selection before fitting. This removes manual
design construction while preserving exact LSS equivalence.</p>
<div class="section level3">
<h3 id="what-oasis-adds-over-optimized-lss">What OASIS Adds Over Optimized LSS<a class="anchor" aria-label="anchor" href="#what-oasis-adds-over-optimized-lss"></a>
</h3>
<ul>
<li>HRF‑aware design: Builds <code>X</code> from events via
<code>fmrihrf</code> (single and multi‑basis), with optional HRF grid
search.</li>
<li>Stabilization: Ridge regularization on per‑trial Gram (absolute and
fractional scaling by design energy).</li>
<li>Inference: Optional standard errors and design diagnostics without
extra passes.</li>
<li>Whitening: Optional AR(1) prewhitening applied consistently to data
and design.</li>
<li>Multi‑basis efficiency: Blocked products and 2K×2K closed‑form
solves for K&gt;1 bases.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="starting-with-oasis-a-simple-example">Starting with OASIS: A Simple Example<a class="anchor" aria-label="anchor" href="#starting-with-oasis-a-simple-example"></a>
</h2>
<p>Let’s begin with a straightforward example that demonstrates OASIS in
action. We’ll create synthetic data with a known ground truth, then see
how OASIS recovers the signal:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create synthetic data</span></span>
<span><span class="va">n_time</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">n_voxels</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">TR</span> <span class="op">&lt;-</span> <span class="fl">1.0</span></span>
<span></span>
<span><span class="co"># Generate event onsets (rapid design)</span></span>
<span><span class="va">onsets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">280</span>, by <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>  <span class="co"># Events every 15 seconds</span></span>
<span><span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">onsets</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create sampling frame</span></span>
<span><span class="va">sframe</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="va">n_time</span>, TR <span class="op">=</span> <span class="va">TR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate synthetic fMRI data</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_time</span> <span class="op">*</span> <span class="va">n_voxels</span><span class="op">)</span>, <span class="va">n_time</span>, <span class="va">n_voxels</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add signal to data</span></span>
<span><span class="va">true_betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_trials</span> <span class="op">*</span> <span class="va">n_voxels</span>, mean <span class="op">=</span> <span class="fl">1</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                     <span class="va">n_trials</span>, <span class="va">n_voxels</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create signal using canonical HRF</span></span>
<span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu">design_matrix</span><span class="op">(</span></span>
<span>  sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>  conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>, name <span class="op">=</span> <span class="st">"task"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  tr_per_trial <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y</span> <span class="op">+</span> <span class="va">dm</span><span class="op">$</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">true_betas</span></span>
<span></span>
<span><span class="co"># Run OASIS</span></span>
<span><span class="va">beta_oasis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># OASIS builds design internally</span></span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>        hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>,</span>
<span>        span <span class="op">=</span> <span class="fl">30</span>  <span class="co"># HRF duration</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"OASIS results:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; OASIS results:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_oasis</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 19 100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean beta:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">beta_oasis</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean beta: 1.01</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta SD:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">beta_oasis</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta SD: 0.587</span></span></code></pre></div>
<p>Notice how OASIS takes a design specification rather than a pre-built
design matrix. This allows it to construct the optimal internal
representation for efficient computation. The results are identical to
what you’d get from standard LSS, but computed much more
efficiently.</p>
</div>
<div class="section level2">
<h2 id="the-power-of-ridge-regularization">The Power of Ridge Regularization<a class="anchor" aria-label="anchor" href="#the-power-of-ridge-regularization"></a>
</h2>
<p>One of OASIS’s most valuable features is built-in ridge
regularization. In rapid event-related designs, the close temporal
spacing of trials can lead to highly correlated regressors and unstable
estimates. Ridge regression adds a small penalty term that “shrinks”
estimates toward zero, trading a small amount of bias for a large
reduction in variance.</p>
<p>OASIS offers two approaches to ridge regularization, each suited to
different scenarios. Let’s explore both:</p>
<div class="section level3">
<h3 id="absolute-ridge-regularization">Absolute Ridge Regularization<a class="anchor" aria-label="anchor" href="#absolute-ridge-regularization"></a>
</h3>
<p>With absolute ridge, you specify fixed penalty values that are added
to the diagonal of the normal equations. This approach gives you direct
control over the regularization strength:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Absolute ridge: fixed penalty values</span></span>
<span><span class="va">beta_ridge_abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"absolute"</span>,</span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.1</span>,  <span class="co"># Penalty on trial regressor</span></span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.1</span>   <span class="co"># Penalty on aggregator regressor</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare with unregularized</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Comparison with unregularized:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Comparison with unregularized:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Correlation:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">beta_oasis</span><span class="op">)</span>,</span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">beta_ridge_abs</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Correlation: 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean absolute difference:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">beta_oasis</span> <span class="op">-</span> <span class="va">beta_ridge_abs</span><span class="op">)</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean absolute difference: 0.0092</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fractional-ridge-regularization">Fractional Ridge Regularization<a class="anchor" aria-label="anchor" href="#fractional-ridge-regularization"></a>
</h3>
<p>Fractional ridge scales the penalty relative to the “energy” (sum of
squares) in the design matrix. This adaptive approach automatically
adjusts to the scale of your data:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fractional ridge: penalty as fraction of design energy</span></span>
<span><span class="va">beta_ridge_frac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.05</span>,  <span class="co"># 5% of mean design energy</span></span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.05</span>   <span class="co"># 5% of mean aggregator energy</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ridge typically reduces variance in estimates</span></span>
<span><span class="va">var_unreg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">beta_oasis</span>, <span class="fl">2</span>, <span class="va">var</span><span class="op">)</span></span>
<span><span class="va">var_ridge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">beta_ridge_frac</span>, <span class="fl">2</span>, <span class="va">var</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nVariance reduction with ridge:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variance reduction with ridge:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean variance (unregularized):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var_unreg</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean variance (unregularized): 0.3378</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean variance (ridge):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var_ridge</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean variance (ridge): 0.3065</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Reduction:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var_ridge</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var_unreg</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Reduction: 9.3 %</span></span></code></pre></div>
<p>The variance reduction demonstrates ridge regression’s stabilizing
effect. In practice, this translates to more reliable estimates,
especially in noisy data or complex designs.</p>
</div>
</div>
<div class="section level2">
<h2 id="working-with-multi-basis-hrfs">Working with Multi-Basis HRFs<a class="anchor" aria-label="anchor" href="#working-with-multi-basis-hrfs"></a>
</h2>
<p>Real hemodynamic responses rarely match the canonical HRF perfectly.
They might peak earlier or later, be wider or narrower, or have
different undershoot characteristics. Multi-basis HRF models capture
this variability by representing the response as a weighted combination
of basis functions.</p>
<p>OASIS handles multi-basis HRFs naturally, returning separate
estimates for each basis component:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use SPMG3: canonical + temporal derivative + dispersion derivative</span></span>
<span><span class="va">beta_spmg3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>        hrf <span class="op">=</span> <span class="va">HRF_SPMG3</span>,  <span class="co"># 3 basis functions</span></span>
<span>        span <span class="op">=</span> <span class="fl">30</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SPMG3 returns K×N rows where K=number of basis functions, N=number of trials</span></span>
<span><span class="co"># The results are organized in blocks: [trial1_basis1, trial1_basis2, trial1_basis3,</span></span>
<span><span class="co">#                                       trial2_basis1, trial2_basis2, trial2_basis3, ...]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Multi-basis results:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Multi-basis results:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 57 100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Basis functions (K):"</span>, <span class="fl">3</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Basis functions (K): 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Trials (N):"</span>, <span class="va">n_trials</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Trials (N): 19</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Total rows (K×N):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Total rows (K×N): 57</span></span>
<span></span>
<span><span class="co"># Extract components using the K-stride pattern</span></span>
<span><span class="co"># For K=3 basis functions, every 3rd row starting from position k gives basis k</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">3</span>  <span class="co"># Number of basis functions in SPMG3</span></span>
<span><span class="va">canonical_betas</span> <span class="op">&lt;-</span> <span class="va">beta_spmg3</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">K</span><span class="op">)</span>, <span class="op">]</span>    <span class="co"># Basis 1: Canonical</span></span>
<span><span class="va">temporal_betas</span> <span class="op">&lt;-</span> <span class="va">beta_spmg3</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">K</span><span class="op">)</span>, <span class="op">]</span>     <span class="co"># Basis 2: Temporal derivative</span></span>
<span><span class="va">dispersion_betas</span> <span class="op">&lt;-</span> <span class="va">beta_spmg3</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">K</span><span class="op">)</span>, <span class="op">]</span>   <span class="co"># Basis 3: Dispersion derivative</span></span>
<span></span>
<span><span class="co"># Verify dimensions: each should be n_trials × n_voxels</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nExtracted component dimensions:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Extracted component dimensions:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Each basis matrix:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">canonical_betas</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Each basis matrix: 19 100</span></span>
<span></span>
<span><span class="co"># Analyze contributions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nBasis function contributions:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Basis function contributions:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Canonical mean |beta|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">canonical_betas</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Canonical mean |beta|: 1.046</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Temporal deriv mean |beta|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">temporal_betas</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Temporal deriv mean |beta|: 0.686</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Dispersion deriv mean |beta|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">dispersion_betas</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Dispersion deriv mean |beta|: 1.235</span></span>
<span></span>
<span><span class="co"># Visualize first voxel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">canonical_betas</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"b"</span>, main <span class="op">=</span> <span class="st">"Canonical"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Beta"</span>, xlab <span class="op">=</span> <span class="st">"Trial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">temporal_betas</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"b"</span>, main <span class="op">=</span> <span class="st">"Temporal Derivative"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Beta"</span>, xlab <span class="op">=</span> <span class="st">"Trial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dispersion_betas</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"b"</span>, main <span class="op">=</span> <span class="st">"Dispersion Derivative"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Beta"</span>, xlab <span class="op">=</span> <span class="st">"Trial"</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/multi-basis-1.png" width="768"></p>
<p>The multi-basis approach reveals how the hemodynamic response varies
across trials. Large temporal derivative values suggest timing
variability, while dispersion derivative values indicate width changes.
This information can be valuable for understanding physiological
variations or task-related modulations of the hemodynamic response.</p>
</div>
<div class="section level2">
<h2 id="non-parametric-hrf-modeling-with-fir">Non-Parametric HRF Modeling with FIR<a class="anchor" aria-label="anchor" href="#non-parametric-hrf-modeling-with-fir"></a>
</h2>
<p>Sometimes you want to make no assumptions about HRF shape at all. The
Finite Impulse Response (FIR) basis provides a completely non-parametric
approach, estimating the response at each time point independently:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create FIR basis with 15 time bins (2s width over a 30s window)</span></span>
<span><span class="va">fir_hrf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/hrf_fir_generator.html" class="external-link">hrf_fir_generator</a></span><span class="op">(</span>nbasis <span class="op">=</span> <span class="fl">15</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">fir_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">fir_hrf</span>, <span class="st">"params"</span><span class="op">)</span></span>
<span><span class="va">bin_width</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fir_params</span><span class="op">[[</span><span class="st">"bin_width"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">n_bins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">fir_hrf</span>, <span class="st">"nbasis"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_fir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>        hrf <span class="op">=</span> <span class="va">fir_hrf</span>,</span>
<span>        span <span class="op">=</span> <span class="fl">30</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.2</span>,  <span class="co"># Moderate ridge improves stability for high-dimensional FIR fits</span></span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.2</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"FIR basis results:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; FIR basis results:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_fir</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 285 100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Time bins per trial:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_fir</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_trials</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Time bins per trial: 15</span></span>
<span></span>
<span><span class="co"># Organise coefficients as (time bin × trial × voxel)</span></span>
<span><span class="va">fir_array</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">beta_fir</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_bins</span>, <span class="va">n_trials</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">beta_fir</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Average across trials and voxels to recover a smooth HRF estimate</span></span>
<span><span class="va">fir_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fir_array</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">fir_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fir_array</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">n_trials</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">beta_fir</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">time_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">(</span><span class="va">n_bins</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">bin_width</span>, by <span class="op">=</span> <span class="va">bin_width</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot mean HRF with ±1 SE ribbon</span></span>
<span><span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">fir_mean</span> <span class="op">+</span> <span class="va">fir_se</span></span>
<span><span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">fir_mean</span> <span class="op">-</span> <span class="va">fir_se</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">time_points</span>, <span class="va">fir_mean</span>, type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">lower</span>, <span class="va">upper</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"FIR-derived HRF (mean across trials/voxels)"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Time (seconds)"</span>, ylab <span class="op">=</span> <span class="st">"Response"</span>,</span>
<span>     col <span class="op">=</span> <span class="st">"navy"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">time_points</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">time_points</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">upper</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">lower</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="st">"navy"</span>, alpha.f <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, border <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time_points</span>, <span class="va">fir_mean</span>, col <span class="op">=</span> <span class="st">"navy"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add canonical HRF sampled on the same grid for reference</span></span>
<span><span class="va">canonical</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">HRF_SPMG1</span>, <span class="va">time_points</span><span class="op">)</span></span>
<span><span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">fir_mean</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">canonical</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time_points</span>, <span class="va">canonical</span> <span class="op">*</span> <span class="va">scale_factor</span>, col <span class="op">=</span> <span class="st">"firebrick"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FIR mean"</span>, <span class="st">"±1 SE"</span>, <span class="st">"Canonical (scaled)"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"navy"</span>, <span class="cn">NA</span>, <span class="st">"firebrick"</span><span class="op">)</span>,</span>
<span>       lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>       lwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">15</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>       pt.cex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">2</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>       pt.bg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="st">"navy"</span>, alpha.f <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>       bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/fir-basis-1.png" width="768"></p>
<p>The FIR approach reveals the actual shape of the hemodynamic response
without parametric constraints. Because each trial now contributes one
coefficient per time bin, individual voxel-level estimates can look
jagged—the variance is simply much higher than in the single-parameter
canonical fit. Averaging across trials and voxels (and adding a modest
ridge penalty) recovers a smooth, HRF-like curve while still allowing
deviations from the canonical shape. In practice you would typically
pool information across voxels/regions or apply additional
smoothing/regularization when working with FIR bases.</p>
</div>
<div class="section level2">
<h2 id="optimizing-hrf-models-through-grid-search">Optimizing HRF Models Through Grid Search<a class="anchor" aria-label="anchor" href="#optimizing-hrf-models-through-grid-search"></a>
</h2>
<p>When you’re unsure which HRF model best fits your data, OASIS can
efficiently evaluate multiple candidates. This exploratory approach
helps identify the optimal HRF parameters for your specific dataset and
brain regions:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Source HRF recovery functions (from previous vignette)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"../R/oasis_hrf_recovery.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a grid of HRF models with varying parameters</span></span>
<span><span class="va">hrf_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_lwu_grid.html">create_lwu_grid</a></span><span class="op">(</span></span>
<span>  tau_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span>,      <span class="co"># Peak time</span></span>
<span>  sigma_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3.5</span><span class="op">)</span>,  <span class="co"># Width</span></span>
<span>  rho_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span><span class="op">)</span>,  <span class="co"># Undershoot</span></span>
<span>  n_tau <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  n_sigma <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  n_rho <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Testing"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">hrf_grid</span><span class="op">$</span><span class="va">hrfs</span><span class="op">)</span>, <span class="st">"different HRF models\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Testing 12 different HRF models</span></span>
<span></span>
<span><span class="co"># Test each HRF and select best based on fit</span></span>
<span><span class="va">best_fit</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span><span class="va">best_idx</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">hrf_grid</span><span class="op">$</span><span class="va">hrfs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create HRF object</span></span>
<span>  <span class="va">tau_val</span> <span class="op">&lt;-</span> <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">sigma_val</span> <span class="op">&lt;-</span> <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">rho_val</span> <span class="op">&lt;-</span> <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">rho</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">hrf_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/hrf_lwu.html" class="external-link">hrf_lwu</a></span><span class="op">(</span><span class="va">t</span>, tau <span class="op">=</span> <span class="va">tau_val</span>, sigma <span class="op">=</span> <span class="va">sigma_val</span>, rho <span class="op">=</span> <span class="va">rho_val</span>, normalize <span class="op">=</span> <span class="st">"height"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hrf"</span>, <span class="st">"function"</span><span class="op">)</span>,</span>
<span>    span <span class="op">=</span> <span class="fl">30</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Fit OASIS with this HRF</span></span>
<span>  <span class="va">beta_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,  <span class="co"># Test on subset for speed</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>    oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>        cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">hrf_obj</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>      ridge_x <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>      ridge_b <span class="op">=</span> <span class="fl">0.01</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate fit (simplified - residual sum of squares)</span></span>
<span>  <span class="va">X_test</span> <span class="op">&lt;-</span> <span class="fu">design_matrix</span><span class="op">(</span></span>
<span>    sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">hrf_obj</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    tr_per_trial <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">X</span></span>
<span></span>
<span>  <span class="va">fitted</span> <span class="op">&lt;-</span> <span class="va">X_test</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta_test</span></span>
<span>  <span class="va">rss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">-</span> <span class="va">fitted</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">-</span><span class="va">rss</span> <span class="op">&gt;</span> <span class="va">best_fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">best_fit</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">rss</span></span>
<span>    <span class="va">best_idx</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Best HRF parameters:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Best HRF parameters:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  tau:"</span>, <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">best_idx</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   tau: 4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  sigma:"</span>, <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">best_idx</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   sigma: 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  rho:"</span>, <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">rho</span><span class="op">[</span><span class="va">best_idx</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   rho: 0.2</span></span></code></pre></div>
<p>Grid search reveals which HRF parameters best explain your data. This
data-driven approach can uncover unexpected characteristics of the
hemodynamic response in your specific experimental context.</p>
</div>
<div class="section level2">
<h2 id="handling-complex-experimental-designs">Handling Complex Experimental Designs<a class="anchor" aria-label="anchor" href="#handling-complex-experimental-designs"></a>
</h2>
<p>Real experiments often involve multiple conditions, with some trials
of interest and others serving as nuisance events. OASIS elegantly
handles these complex scenarios:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create design with two conditions</span></span>
<span><span class="va">onsets_cond1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">280</span>, by <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">onsets_cond2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">280</span>, by <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Condition 1 as target, Condition 2 as nuisance</span></span>
<span><span class="va">beta_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets_cond1</span>,</span>
<span>        hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>,</span>
<span>        span <span class="op">=</span> <span class="fl">30</span></span>
<span>      <span class="op">)</span>,</span>
<span>      others <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets_cond2</span><span class="op">)</span>  <span class="co"># Other conditions as nuisance</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Multi-condition OASIS:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Multi-condition OASIS:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Analyzing condition 1 trials:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">onsets_cond1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Analyzing condition 1 trials: 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Condition 2 included as nuisance\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Condition 2 included as nuisance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_multi</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 10 100</span></span></code></pre></div>
<p>This approach ensures that variance from other conditions is properly
accounted for without conflating it with the trials of interest.</p>
</div>
<div class="section level2">
<h2 id="beyond-point-estimates-standard-errors-and-diagnostics">Beyond Point Estimates: Standard Errors and Diagnostics<a class="anchor" aria-label="anchor" href="#beyond-point-estimates-standard-errors-and-diagnostics"></a>
</h2>
<p>While beta estimates are valuable, understanding their uncertainty is
crucial for proper inference. OASIS can provide standard errors and
diagnostic information:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Request standard errors</span></span>
<span><span class="va">result_with_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,  <span class="co"># Subset for demonstration</span></span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    return_se <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    return_diag <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Results with diagnostics:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Results with diagnostics:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">result_with_se</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 10 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  SE dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">result_with_se</span><span class="op">$</span><span class="va">se</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   SE dimensions: 10 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean SE:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result_with_se</span><span class="op">$</span><span class="va">se</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean SE: 0.3537</span></span>
<span></span>
<span><span class="co"># Calculate t-statistics</span></span>
<span><span class="va">t_stats</span> <span class="op">&lt;-</span> <span class="va">result_with_se</span><span class="op">$</span><span class="va">beta</span> <span class="op">/</span> <span class="va">result_with_se</span><span class="op">$</span><span class="va">se</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean |t-statistic|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">t_stats</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean |t-statistic|: 2.43</span></span>
<span></span>
<span><span class="co"># Visualize SE across trials</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">result_with_se</span><span class="op">$</span><span class="va">se</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Standard Error Across Trials"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Trial"</span>, ylab <span class="op">=</span> <span class="st">"Mean SE"</span>,</span>
<span>     col <span class="op">=</span> <span class="st">"darkblue"</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/standard-errors-1.png" width="768"></p>
<p>Standard errors reveal which estimates are most reliable. Trials with
higher standard errors might be those with more overlapping responses or
occurring during periods of higher noise.</p>
</div>
<div class="section level2">
<h2 id="performance-in-practice">Performance in Practice<a class="anchor" aria-label="anchor" href="#performance-in-practice"></a>
</h2>
<p>To understand OASIS’s efficiency, let’s conduct systematic benchmarks
comparing it with traditional LSS implementations across different
dataset sizes:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Benchmark across different dataset sizes</span></span>
<span><span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  small  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoints <span class="op">=</span> <span class="fl">300</span>, voxels <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>,</span>
<span>  medium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoints <span class="op">=</span> <span class="fl">400</span>, voxels <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>,</span>
<span>  large  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoints <span class="op">=</span> <span class="fl">600</span>, voxels <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span>,</span>
<span>  xlarge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoints <span class="op">=</span> <span class="fl">800</span>, voxels <span class="op">=</span> <span class="fl">16000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">benchmark_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">size_name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sizes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_time</span> <span class="op">&lt;-</span> <span class="va">sizes</span><span class="op">[[</span><span class="va">size_name</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'timepoints'</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">n_vox</span>  <span class="op">&lt;-</span> <span class="va">sizes</span><span class="op">[[</span><span class="va">size_name</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'voxels'</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Create test data</span></span>
<span>  <span class="va">Y_bench</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_time</span> <span class="op">*</span> <span class="va">n_vox</span><span class="op">)</span>, <span class="va">n_time</span>, <span class="va">n_vox</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create sampling frame and onsets for this size</span></span>
<span>  <span class="va">sframe_bench</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="va">n_time</span>, TR <span class="op">=</span> <span class="va">TR</span><span class="op">)</span></span>
<span>  <span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n_time</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">onsets_bench</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">n_time</span> <span class="op">-</span> <span class="fl">20</span>, length.out <span class="op">=</span> <span class="va">n_trials</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Standard LSS with pre-built design (shared across methods)</span></span>
<span>  <span class="va">dm_bench</span> <span class="op">&lt;-</span> <span class="fu">design_matrix</span><span class="op">(</span></span>
<span>    sframe <span class="op">=</span> <span class="va">sframe_bench</span>,</span>
<span>    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets_bench</span>, hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span><span class="op">)</span><span class="op">)</span>,</span>
<span>    tr_per_trial <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span><span class="op">[[</span><span class="st">'X'</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Time standard LSS (R optimized)</span></span>
<span>  <span class="va">time_r_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">beta_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span><span class="va">Y_bench</span>, <span class="va">dm_bench</span>, method <span class="op">=</span> <span class="st">"r_optimized"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Time standard LSS (C++ optimized)</span></span>
<span>  <span class="va">time_cpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">beta_cpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span><span class="va">Y_bench</span>, <span class="va">dm_bench</span>, method <span class="op">=</span> <span class="st">"cpp_optimized"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Time OASIS using the pre-built design (fair comparison)</span></span>
<span>  <span class="va">time_oasis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">beta_oasis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y_bench</span>, X <span class="op">=</span> <span class="va">dm_bench</span>, method <span class="op">=</span> <span class="st">"oasis"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Time OASIS when it also has to build the design internally</span></span>
<span>  <span class="va">time_oasis_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">beta_oasis_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>      Y <span class="op">=</span> <span class="va">Y_bench</span>,</span>
<span>      X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>      oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          sframe <span class="op">=</span> <span class="va">sframe_bench</span>,</span>
<span>          cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            onsets <span class="op">=</span> <span class="va">onsets_bench</span>,</span>
<span>            hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>,</span>
<span>            span <span class="op">=</span> <span class="fl">30</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Store results</span></span>
<span>  <span class="va">benchmark_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">benchmark_results</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Size <span class="op">=</span> <span class="va">size_name</span>,</span>
<span>    Timepoints <span class="op">=</span> <span class="va">n_time</span>,</span>
<span>    Voxels <span class="op">=</span> <span class="va">n_vox</span>,</span>
<span>    Trials <span class="op">=</span> <span class="va">n_trials</span>,</span>
<span>    R_Optimized <span class="op">=</span> <span class="va">time_r_opt</span>,</span>
<span>    CPP_Optimized <span class="op">=</span> <span class="va">time_cpp</span>,</span>
<span>    OASIS <span class="op">=</span> <span class="va">time_oasis</span>,</span>
<span>    OASIS_with_design <span class="op">=</span> <span class="va">time_oasis_build</span>,</span>
<span>    Speedup_vs_R <span class="op">=</span> <span class="va">time_r_opt</span> <span class="op">/</span> <span class="va">time_oasis</span>,</span>
<span>    Speedup_vs_CPP <span class="op">=</span> <span class="va">time_cpp</span> <span class="op">/</span> <span class="va">time_oasis</span>,</span>
<span>    Design_Build_Overhead <span class="op">=</span> <span class="va">time_oasis_build</span> <span class="op">-</span> <span class="va">time_oasis</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Display rounded results for readability</span></span>
<span><span class="va">numeric_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">)</span>, <span class="st">"Size"</span><span class="op">)</span></span>
<span><span class="va">benchmark_display</span> <span class="op">&lt;-</span> <span class="va">benchmark_results</span></span>
<span><span class="va">benchmark_display</span><span class="op">[</span><span class="va">numeric_cols</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">benchmark_display</span><span class="op">[</span><span class="va">numeric_cols</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">benchmark_display</span><span class="op">)</span></span>
<span><span class="co">#&gt;            Size Timepoints Voxels Trials R_Optimized CPP_Optimized OASIS</span></span>
<span><span class="co">#&gt; elapsed   small        300    500     30       0.005         0.017 0.002</span></span>
<span><span class="co">#&gt; elapsed1 medium        400   2000     40       0.014         0.111 0.009</span></span>
<span><span class="co">#&gt; elapsed2  large        600   8000     60       0.070         0.064 0.051</span></span>
<span><span class="co">#&gt; elapsed3 xlarge        800  16000     60       0.167         0.192 0.124</span></span>
<span><span class="co">#&gt;          OASIS_with_design Speedup_vs_R Speedup_vs_CPP Design_Build_Overhead</span></span>
<span><span class="co">#&gt; elapsed              0.021        2.500          8.500                 0.019</span></span>
<span><span class="co">#&gt; elapsed1             0.037        1.556         12.333                 0.028</span></span>
<span><span class="co">#&gt; elapsed2             0.088        1.373          1.255                 0.037</span></span>
<span><span class="co">#&gt; elapsed3             0.168        1.347          1.548                 0.044</span></span>
<span></span>
<span><span class="co"># Visualize scaling</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Time vs dataset size</span></span>
<span><span class="va">ylim_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R_Optimized"</span>, <span class="st">"CPP_Optimized"</span>, <span class="st">"OASIS_with_design"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">benchmark_results</span><span class="op">$</span><span class="va">R_Optimized</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"blue"</span>, pch <span class="op">=</span> <span class="fl">19</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Number of Voxels"</span>, ylab <span class="op">=</span> <span class="st">"Time (seconds)"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Computation Time Scaling"</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ylim_max</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">benchmark_results</span><span class="op">$</span><span class="va">CPP_Optimized</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"darkgreen"</span>, pch <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">benchmark_results</span><span class="op">$</span><span class="va">OASIS</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">17</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">benchmark_results</span><span class="op">$</span><span class="va">OASIS_with_design</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span>, pch <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R Optimized"</span>, <span class="st">"C++ Optimized"</span>, <span class="st">"OASIS (pre-built X)"</span>, <span class="st">"OASIS (build design)"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"darkgreen"</span>, <span class="st">"red"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">19</span>, <span class="fl">15</span>, <span class="fl">17</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>       lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Speedup factor</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Speedup_vs_R</span>,</span>
<span>        names.arg <span class="op">=</span> <span class="va">benchmark_results</span><span class="op">$</span><span class="va">Size</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"OASIS Speedup vs R Optimized"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Speedup Factor"</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/performance-comparison-1.png" width="768"></p>
<pre><code>
These benchmarks show that all three optimized backends sit within a few percent of one another across the regimes we tested. The R and fused C++ paths are already very efficient, and OASIS closely tracks them even as we scale to tens of thousands of voxels and dozens of trials. The `OASIS (build design)` curve highlights another key point: if you let OASIS construct the design inside the call you pay the additional cost of HRF convolution, so for apples-to-apples comparisons you should pre-build and reuse `X` just as you would for the other methods.

The exact ordering will vary with hardware, trial spacing, and nuisance structure—on some reruns OASIS edges ahead, on others the R or C++ backend wins by a similar margin. The takeaway is that OASIS keeps pace with the existing optimized solvers while additionally providing HRF-aware design construction, ridge regularization, whitening, and diagnostics.

## Creating Custom HRF Functions

OASIS's flexibility extends to custom HRF functions, allowing you to implement novel hemodynamic models:


``` r
# Create custom double-gamma HRF
custom_hrf &lt;- function(t, a1 = 6, a2 = 16, b1 = 1, b2 = 1, c = 1/6) {
  # Double gamma function
  dgamma(t, a1, b1) - c * dgamma(t, a2, b2)
}

# Wrap as HRF object
custom_hrf_obj &lt;- structure(
  custom_hrf,
  class = c("hrf", "function"),
  span = 30
)

# Use with OASIS
beta_custom &lt;- lss(
  Y = Y[, 1:10],
  X = NULL,
  method = "oasis",
  oasis = list(
    design_spec = list(
      sframe = sframe,
      cond = list(
        onsets = onsets[1:10],
        hrf = custom_hrf_obj,
        span = 30
      )
    )
  )
)

cat("Custom HRF results:\n")
#&gt; Custom HRF results:
cat("  Beta dimensions:", dim(beta_custom), "\n")
#&gt;   Beta dimensions: 10 10
cat("  Mean beta:", round(mean(beta_custom), 3), "\n")
#&gt;   Mean beta: 7.921</code></pre>
<p>This capability allows you to test hypotheses about hemodynamic
response characteristics or adapt models from other software
packages.</p>
</div>
<div class="section level2">
<h2 id="practical-guidance-for-ridge-parameter-selection">Practical Guidance for Ridge Parameter Selection<a class="anchor" aria-label="anchor" href="#practical-guidance-for-ridge-parameter-selection"></a>
</h2>
<p>Choosing appropriate ridge parameters is crucial for optimal
performance. Too little regularization leaves estimates unstable; too
much biases them toward zero. Here’s a systematic approach to
selection:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test different ridge values</span></span>
<span><span class="va">ridge_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">ridge_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ridge</span> <span class="kw">in</span> <span class="va">ridge_values</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">beta_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,</span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>    oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>        cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>      ridge_x <span class="op">=</span> <span class="va">ridge</span>,</span>
<span>      ridge_b <span class="op">=</span> <span class="va">ridge</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">ridge_results</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ridge</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mean_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">beta_r</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sd_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">beta_r</span><span class="op">)</span>,</span>
<span>    condition_number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/kappa.html" class="external-link">kappa</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">beta_r</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Ridge parameter selection:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Ridge parameter selection:</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ridge_results</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Ridge = %s: mean|β| = %.3f, SD = %.3f, κ = %.1f\n"</span>,</span>
<span>              <span class="va">r</span>, <span class="va">ridge_results</span><span class="op">[[</span><span class="va">r</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mean_beta</span>,</span>
<span>              <span class="va">ridge_results</span><span class="op">[[</span><span class="va">r</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sd_beta</span>,</span>
<span>              <span class="va">ridge_results</span><span class="op">[[</span><span class="va">r</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">condition_number</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;   Ridge = 0: mean|β| = 1.087, SD = 0.648, κ = 27.3</span></span>
<span><span class="co">#&gt;   Ridge = 0.001: mean|β| = 1.086, SD = 0.648, κ = 27.3</span></span>
<span><span class="co">#&gt;   Ridge = 0.01: mean|β| = 1.072, SD = 0.642, κ = 27.3</span></span>
<span><span class="co">#&gt;   Ridge = 0.05: mean|β| = 1.013, SD = 0.616, κ = 27.3</span></span>
<span><span class="co">#&gt;   Ridge = 0.1: mean|β| = 0.947, SD = 0.587, κ = 27.2</span></span></code></pre></div>
<p>The condition number (κ) indicates numerical stability—lower values
suggest more stable estimates. The tradeoff between bias (reduced mean
beta) and variance (reduced SD) guides your choice.</p>
</div>
<div class="section level2">
<h2 id="memory-usage-comparison">Memory Usage Comparison<a class="anchor" aria-label="anchor" href="#memory-usage-comparison"></a>
</h2>
<p>Understanding the memory trade-offs between OASIS and standard LSS is
important for choosing the right method for your computational
resources:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare memory usage across methods</span></span>
<span><span class="va">memory_comparison</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_time</span>, <span class="va">n_vox</span>, <span class="va">n_trials</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Calculate memory requirements (in MB)</span></span>
<span>  <span class="va">double_size</span> <span class="op">&lt;-</span> <span class="fl">8</span>  <span class="co"># bytes per double</span></span>
<span></span>
<span>  <span class="co"># Standard LSS memory (per iteration)</span></span>
<span>  <span class="co"># Stores: current X_trial (n_time × 2), beta result (n_trials × n_vox)</span></span>
<span>  <span class="va">lss_per_iter</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n_time</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">n_vox</span><span class="op">)</span> <span class="op">*</span> <span class="va">double_size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">lss_total</span> <span class="op">&lt;-</span> <span class="va">lss_per_iter</span>  <span class="co"># Only peak memory matters</span></span>
<span></span>
<span>  <span class="co"># OASIS memory (upfront)</span></span>
<span>  <span class="co"># Stores: X (n_time × n_trials), precomputed terms, results</span></span>
<span>  <span class="va">oasis_X</span> <span class="op">&lt;-</span> <span class="va">n_time</span> <span class="op">*</span> <span class="va">n_trials</span> <span class="op">*</span> <span class="va">double_size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">oasis_precomp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n_trials</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">n_trials</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">double_size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span>  <span class="co"># Gram matrices</span></span>
<span>  <span class="va">oasis_results</span> <span class="op">&lt;-</span> <span class="va">n_trials</span> <span class="op">*</span> <span class="va">n_vox</span> <span class="op">*</span> <span class="va">double_size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">oasis_total</span> <span class="op">&lt;-</span> <span class="va">oasis_X</span> <span class="op">+</span> <span class="va">oasis_precomp</span> <span class="op">+</span> <span class="va">oasis_results</span></span>
<span></span>
<span>  <span class="co"># For multi-basis (K=3), multiply by K</span></span>
<span>  <span class="va">oasis_multibasis</span> <span class="op">&lt;-</span> <span class="va">oasis_total</span> <span class="op">*</span> <span class="fl">3</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Timepoints <span class="op">=</span> <span class="va">n_time</span>,</span>
<span>    Voxels <span class="op">=</span> <span class="va">n_vox</span>,</span>
<span>    Trials <span class="op">=</span> <span class="va">n_trials</span>,</span>
<span>    LSS_MB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">lss_total</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    OASIS_MB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">oasis_total</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    OASIS_Multi_MB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">oasis_multibasis</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    Ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">oasis_total</span> <span class="op">/</span> <span class="va">lss_total</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    Ratio_Multi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">oasis_multibasis</span> <span class="op">/</span> <span class="va">lss_total</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Test different dataset sizes</span></span>
<span><span class="va">mem_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu">memory_comparison</span><span class="op">(</span><span class="fl">200</span>, <span class="fl">100</span>, <span class="fl">15</span><span class="op">)</span>,    <span class="co"># Small</span></span>
<span>  <span class="fu">memory_comparison</span><span class="op">(</span><span class="fl">300</span>, <span class="fl">1000</span>, <span class="fl">30</span><span class="op">)</span>,   <span class="co"># Medium</span></span>
<span>  <span class="fu">memory_comparison</span><span class="op">(</span><span class="fl">400</span>, <span class="fl">10000</span>, <span class="fl">50</span><span class="op">)</span>,  <span class="co"># Large</span></span>
<span>  <span class="fu">memory_comparison</span><span class="op">(</span><span class="fl">500</span>, <span class="fl">50000</span>, <span class="fl">100</span><span class="op">)</span>  <span class="co"># Very large</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Timepoints Voxels Trials LSS_MB OASIS_MB OASIS_Multi_MB Ratio Ratio_Multi</span></span>
<span><span class="co">#&gt; 1        200    100     15   0.00     0.04           0.11   9.5        28.6</span></span>
<span><span class="co">#&gt; 2        300   1000     30   0.01     0.31           0.92  25.0        75.0</span></span>
<span><span class="co">#&gt; 3        400  10000     50   0.08     3.99          11.96  48.4       145.2</span></span>
<span><span class="co">#&gt; 4        500  50000    100   0.39    38.61         115.82  99.2       297.7</span></span>
<span></span>
<span><span class="co"># Visualize memory scaling</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Memory usage comparison</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">mem_results</span><span class="op">$</span><span class="va">LSS_MB</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"blue"</span>, pch <span class="op">=</span> <span class="fl">19</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Number of Voxels"</span>, ylab <span class="op">=</span> <span class="st">"Memory (MB)"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Memory Usage Comparison"</span>,</span>
<span>     log <span class="op">=</span> <span class="st">"xy"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in xy.coords(x, y, xlabel, ylabel, log): 1 y value &lt;= 0 omitted from</span></span>
<span><span class="co">#&gt; logarithmic plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">mem_results</span><span class="op">$</span><span class="va">OASIS_MB</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">17</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">mem_results</span><span class="op">$</span><span class="va">OASIS_Multi_MB</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"orange"</span>, pch <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Standard LSS"</span>, <span class="st">"OASIS"</span>, <span class="st">"OASIS Multi-basis"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"orange"</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">19</span>, <span class="fl">17</span>, <span class="fl">15</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Memory ratio</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ratio"</span>, <span class="st">"Ratio_Multi"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        beside <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        names.arg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="st">"vox"</span><span class="op">)</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"Memory Usage Ratio (OASIS/LSS)"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Memory Ratio"</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"orange"</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"OASIS"</span>, <span class="st">"OASIS Multi-basis"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/memory-comparison-1.png" width="768"></p>
<p>As shown, OASIS requires more upfront memory due to precomputed
matrices, but this investment enables its computational efficiency. The
memory overhead is most noticeable with multi-basis HRFs and large
numbers of trials. For memory-constrained systems, consider using
blocked processing or standard LSS for very large datasets.</p>
</div>
<div class="section level2">
<h2 id="advanced-features-for-production-use">Advanced Features for Production Use<a class="anchor" aria-label="anchor" href="#advanced-features-for-production-use"></a>
</h2>
<p>When deploying OASIS in production analyses, several advanced
features enhance efficiency and robustness.</p>
<div class="section level3">
<h3 id="memory-efficient-block-processing">Memory-Efficient Block Processing<a class="anchor" aria-label="anchor" href="#memory-efficient-block-processing"></a>
</h3>
<p>For datasets too large to fit in memory, OASIS can process voxels in
blocks:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For very large datasets, use blocked processing</span></span>
<span><span class="va">block_size</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">n_blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">/</span> <span class="va">block_size</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># OASIS with blocked voxels</span></span>
<span><span class="va">oasis_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>    cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  block_cols <span class="op">=</span> <span class="va">block_size</span>  <span class="co"># Process voxels in blocks</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_blocked</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span><span class="va">Y</span>, X <span class="op">=</span> <span class="cn">NULL</span>, method <span class="op">=</span> <span class="st">"oasis"</span>, oasis <span class="op">=</span> <span class="va">oasis_config</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="temporal-autocorrelation-correction">Temporal Autocorrelation Correction<a class="anchor" aria-label="anchor" href="#temporal-autocorrelation-correction"></a>
</h3>
<p>fMRI data exhibits temporal autocorrelation that can bias standard
errors. OASIS can apply AR(1) prewhitening:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># OASIS with AR(1) prewhitening</span></span>
<span><span class="va">beta_whitened</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    whiten <span class="op">=</span> <span class="st">"ar1"</span>  <span class="co"># Enable AR(1) whitening</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"AR(1) whitening applied\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; AR(1) whitening applied</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_whitened</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 10 10</span></span></code></pre></div>
<p>Prewhitening improves the validity of statistical inference,
particularly for standard errors and hypothesis tests.</p>
</div>
</div>
<div class="section level2">
<h2 id="when-oasis-shines-use-case-recommendations">When OASIS Shines: Use Case Recommendations<a class="anchor" aria-label="anchor" href="#when-oasis-shines-use-case-recommendations"></a>
</h2>
<p>Through extensive testing and application, we’ve identified scenarios
where OASIS provides the greatest benefits.</p>
<p>Rapid event-related designs with inter-stimulus intervals under 10
seconds benefit enormously from OASIS’s efficient handling of
overlapping responses. The method’s speed advantage becomes crucial when
dealing with experiments containing hundreds or thousands of trials.</p>
<p>For exploratory analyses where the optimal HRF is unknown, OASIS’s
ability to quickly evaluate multiple HRF models enables data-driven
model selection. The computational efficiency makes it feasible to test
dozens of HRF variants across multiple brain regions.</p>
<p>Large-scale analyses involving whole-brain data or multiple subjects
particularly benefit from OASIS’s speed. What might take days with
traditional LSS can often be completed in hours with OASIS, enabling
more iterative and thorough analyses.</p>
<p>Designs prone to collinearity—whether from rapid presentation, long
HRFs, or correlated experimental factors—benefit from OASIS’s integrated
ridge regression. The regularization happens naturally within the
estimation framework rather than requiring post-hoc adjustments.</p>
</div>
<div class="section level2">
<h2 id="limitations-and-considerations">Limitations and Considerations<a class="anchor" aria-label="anchor" href="#limitations-and-considerations"></a>
</h2>
<p>While OASIS offers substantial advantages, it’s important to
understand its limitations and when simpler approaches might
suffice.</p>
<p>The method requires more memory than iterative LSS approaches since
it constructs larger intermediate matrices. For extremely large datasets
on memory-constrained systems, traditional LSS with careful memory
management might be necessary.</p>
<p>OASIS’s design specification system, while powerful, has a learning
curve. For simple analyses with pre-constructed design matrices,
standard LSS might be more straightforward to implement.</p>
<p>The mathematical optimizations that make OASIS fast also make it less
transparent. If you need to understand or modify the estimation
procedure, the traditional LSS implementation offers clearer code
paths.</p>
</div>
<div class="section level2">
<h2 id="looking-ahead">Looking Ahead<a class="anchor" aria-label="anchor" href="#looking-ahead"></a>
</h2>
<p>OASIS represents the current state-of-the-art in LSS implementation,
combining theoretical rigor with computational efficiency. As fMRI data
continues to grow in resolution and complexity, methods like OASIS
become not just useful but essential for practical analysis.</p>
<p>Future developments might include adaptive regularization that
automatically selects optimal ridge parameters, integration with machine
learning frameworks for end-to-end optimization, and extensions to
handle even more complex experimental designs.</p>
<p>The <code>fmrilss</code> package will continue to evolve with these
advances, maintaining OASIS as a cornerstone of efficient trial-wise
estimation. Whether you’re working with standard datasets or pushing the
boundaries of fMRI acquisition, OASIS provides the tools you need for
rigorous, efficient analysis.</p>
</div>
<div class="section level2">
<h2 id="summary-and-next-steps">Summary and Next Steps<a class="anchor" aria-label="anchor" href="#summary-and-next-steps"></a>
</h2>
<p>This vignette has taken you through the full capabilities of the
OASIS method, from basic usage to advanced features. You’ve seen how
OASIS achieves dramatic speedups through mathematical reformulation,
provides numerical stability through integrated ridge regression,
handles flexible HRF models seamlessly, and scales to large datasets
efficiently.</p>
<p>To continue your journey, explore the getting started vignette for
foundational LSS concepts, the voxel-wise HRF vignette for spatial
modeling of hemodynamic responses, and the package examples directory
for real-world applications. The theoretical details of OASIS are being
prepared for publication, offering deeper insights into the mathematical
innovations that make this method possible.</p>
<p>OASIS transforms LSS from a computationally intensive procedure to a
practical tool for everyday fMRI analysis. By combining speed,
flexibility, and robustness, it enables analyses that would otherwise be
infeasible, opening new possibilities for understanding brain function
through event-related fMRI.</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>See <code><a href="../articles/getting_started.html">vignette("getting_started")</a></code> for LSS basics See
<code><a href="../articles/voxel-wise-hrf.html">vignette("voxel-wise-hrf")</a></code> for spatial HRF variation Review
the <code>examples/oasis_example.R</code> for additional demonstrations
Consult the OASIS paper (in preparation) for theoretical details</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Brad Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
