<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The OASIS Method: Optimized Analytic Single-pass Inverse Solution • fmrilss</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The OASIS Method: Optimized Analytic Single-pass Inverse Solution">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmrilss</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting_started.html">Getting Started with fmrilss</a></li>
    <li><a class="dropdown-item" href="../articles/oasis_method.html">The OASIS Method: Optimized Analytic Single-pass Inverse Solution</a></li>
    <li><a class="dropdown-item" href="../articles/oasis_theory.html">OASIS Theory: Algebra and Implementation Details</a></li>
    <li><a class="dropdown-item" href="../articles/sbhm.html">Shared-Basis HRF Matching (SBHM): Efficient Voxel-Specific HRF Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/voxel-wise-hrf.html">Voxel-wise HRF Modeling with fmrilss</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>The OASIS Method: Optimized Analytic Single-pass Inverse Solution</h1>
                        <h4 data-toc-skip class="author">fmrilss
Development Team</h4>
            
            <h4 data-toc-skip class="date">2025-10-31</h4>
      

      <div class="d-none name"><code>oasis_method.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-computational-challenge-of-modern-fmri">The Computational Challenge of Modern fMRI<a class="anchor" aria-label="anchor" href="#the-computational-challenge-of-modern-fmri"></a>
</h2>
<p>Modern fMRI datasets with sub-millimeter resolution and thousands of
trials require millions of model fits when using standard LSS
approaches. For datasets with 100,000 voxels and 500 trials, traditional
LSS requires 50 million separate GLM fits, each involving matrix
inversion and parameter estimation.</p>
<p>OASIS (Optimized Analytic Single-pass Inverse Solution) addresses
this computational challenge through mathematical reformulation. Instead
of iterating through trials sequentially, OASIS exploits the shared
structure across LSS models to compute all trial estimates
simultaneously. Compared to the naive per-trial GLM approach (O(N·T³)),
the factored approach reduces the dominant work to a single
decomposition plus shared projections (roughly O(T³ + N·T·V)). Note that
fmrilss’s optimized LSS backends already exploit this same factoring;
OASIS packages the same estimator and extends it to HRF-aware design
building and multi-basis solves.</p>
<p>OASIS also provides: automatic HRF estimation with multi-basis
functions, ridge regularization for numerical stability, efficient
handling of complex experimental designs, and integration with
prewhitening for autocorrelation correction.</p>
<p>Prerequisites: familiarity with LSS concepts, HRF models and basis
functions, ridge regression principles, and the <code>fmrihrf</code>
package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/" class="external-link">fmrihrf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrilss/">fmrilss</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Note: we build designs inline with fmrihrf primitives (regressor_set + evaluate)</span></span>
<span><span class="co"># to keep examples short and readable.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="understanding-the-oasis-innovation">Understanding the OASIS Innovation<a class="anchor" aria-label="anchor" href="#understanding-the-oasis-innovation"></a>
</h2>
<p>OASIS exploits the mathematical structure of LSS: the N separate GLMs
share computational components that can be factored and reused across
trials. Note this factoring is already exploited by fmrilss’s optimized
backends (e.g., the fused single-pass solver that residualizes once and
reuses totals and cross-products across trials). Importantly, for a
single-basis HRF (K = 1) and no ridge (ridge_x = ridge_b = 0), OASIS is
mathematically identical to the core LSS estimator; it simply computes
the same betas in one batched pass. OASIS then wraps this core solve in
a richer, HRF-aware workflow: automatic design construction from event
specs, optional ridge scaling, AR(1) whitening, SE/diagnostic reporting,
and native support for multi-basis or FIR HRFs.</p>
<p>Beyond computational efficiency, OASIS adds features that the generic
LSS path does not expose: built-in ridge regularization (absolute and
fractional) on the two-regressor Gram per trial, optional AR(1)
whitening, analytical standard errors and diagnostics, and a blocked
multi-basis solver that treats K&gt;1 HRF bases as 2Kx2K closed-form
systems per trial.</p>
<p>Finally, OASIS integrates directly with fmrihrf: it builds trial-wise
designs from event specs (including multi-condition aggregates),
auto-detects basis dimension K, supports FIR/non-parametric bases, and
can run fast HRF grid selection before fitting. This removes manual
design construction while preserving exact LSS equivalence.</p>
<div class="section level3">
<h3 id="what-oasis-adds-over-optimized-lss">What OASIS Adds Over Optimized LSS<a class="anchor" aria-label="anchor" href="#what-oasis-adds-over-optimized-lss"></a>
</h3>
<ul>
<li>HRF-aware design: Builds <code>X</code> from events via
<code>fmrihrf</code> (single and multi-basis), with optional HRF grid
search.</li>
<li>Stabilization: Ridge regularization on per‑trial Gram (absolute and
fractional scaling by design energy).</li>
<li>Inference: Optional standard errors and design diagnostics without
extra passes.</li>
<li>Whitening: Optional AR(1) prewhitening applied consistently to data
and design.</li>
<li>Multi-basis efficiency: Blocked products and 2Kx2K closed-form
solves for K&gt;1 bases.</li>
</ul>
</div>
<div class="section level3">
<h3 id="equivalence-to-lss-k-1-no-ridge">Equivalence to LSS (K = 1, no ridge)<a class="anchor" aria-label="anchor" href="#equivalence-to-lss-k-1-no-ridge"></a>
</h3>
<p>When you already have a single-basis trial-wise design <code>X</code>
and you do not use ridge, <code>lss(..., method = "oasis")</code>
returns the same coefficients as the optimized LSS path. This quick
check verifies numerical equivalence up to floating-point tolerance:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">120</span>; <span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="fl">15</span>; <span class="va">V</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">n_trials</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">n_trials</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span>, <span class="va">n</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">V</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">V</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b_lss</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">X</span>, Z <span class="op">=</span> <span class="va">Z</span>, Nuisance <span class="op">=</span> <span class="va">N</span>, method <span class="op">=</span> <span class="st">"cpp_optimized"</span><span class="op">)</span></span>
<span><span class="va">b_oasis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">X</span>, Z <span class="op">=</span> <span class="va">Z</span>, Nuisance <span class="op">=</span> <span class="va">N</span>, method <span class="op">=</span> <span class="st">"oasis"</span>, oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ridge_x <span class="op">=</span> <span class="fl">0</span>, ridge_b <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">b_lss</span> <span class="op">-</span> <span class="va">b_oasis</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Use the plain LSS backends when you have a fixed single-basis
<code>X</code> and want the leanest dependency surface. Prefer OASIS
when you want built-in HRF design construction, multi-basis HRFs (K &gt;
1), ridge control, or standard errors/diagnostics in one call.</p>
</div>
<div class="section level3">
<h3 id="when-to-use-which">When To Use Which<a class="anchor" aria-label="anchor" href="#when-to-use-which"></a>
</h3>
<ul>
<li>Use <code>lss(..., method = "cpp_optimized")</code> when:
<ul>
<li>You already have a trial-wise single-basis <code>X</code>.</li>
<li>You do not need ridge, SEs, or HRF grid search.</li>
<li>You want the minimal dependency surface and maximum simplicity.</li>
</ul>
</li>
<li>Use <code>lss(..., method = "oasis")</code> when:
<ul>
<li>You want to build <code>X</code> directly from event specs/HRFs in
the call.</li>
<li>You need multi-basis HRFs (K &gt; 1) or FIR.</li>
<li>You want ridge regularization, SEs/diagnostics, or AR(1) whitening
in one pass.</li>
<li>You want optional HRF grid search and design diagnostics.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="starting-with-oasis-a-simple-example">Starting with OASIS: A Simple Example<a class="anchor" aria-label="anchor" href="#starting-with-oasis-a-simple-example"></a>
</h2>
<p>Let’s begin with a straightforward example that demonstrates OASIS in
action. We’ll create synthetic data with a known ground truth, then see
how OASIS recovers the signal:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create synthetic data</span></span>
<span><span class="va">n_time</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">n_voxels</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">TR</span> <span class="op">&lt;-</span> <span class="fl">1.0</span></span>
<span></span>
<span><span class="co"># Generate event onsets (rapid, jittered ISIs ~ U(3, 9) s)</span></span>
<span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">isi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">500</span>, min <span class="op">=</span> <span class="fl">3</span>, max <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>                  <span class="co"># generous upper bound</span></span>
<span><span class="va">onsets_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">start_time</span>, <span class="va">start_time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">isi</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">onsets</span> <span class="op">&lt;-</span> <span class="va">onsets_cont</span><span class="op">[</span><span class="va">onsets_cont</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">n_time</span> <span class="op">-</span> <span class="fl">20</span><span class="op">)</span><span class="op">]</span>    <span class="co"># leave tail for HRF span</span></span>
<span><span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">onsets</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create sampling frame</span></span>
<span><span class="va">sframe</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="va">n_time</span>, TR <span class="op">=</span> <span class="va">TR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate synthetic fMRI data</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_time</span> <span class="op">*</span> <span class="va">n_voxels</span><span class="op">)</span>, <span class="va">n_time</span>, <span class="va">n_voxels</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add signal to data</span></span>
<span><span class="va">true_betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_trials</span> <span class="op">*</span> <span class="va">n_voxels</span>, mean <span class="op">=</span> <span class="fl">1</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                     <span class="va">n_trials</span>, <span class="va">n_voxels</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create signal using canonical HRF</span></span>
<span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/samples.html" class="external-link">samples</a></span><span class="op">(</span><span class="va">sframe</span>, global <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">rset</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor_set.html" class="external-link">regressor_set</a></span><span class="op">(</span></span>
<span>  onsets   <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>  fac      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_trials</span><span class="op">)</span><span class="op">)</span>,  <span class="co"># one column per trial</span></span>
<span>  hrf      <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>,</span>
<span>  duration <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  span     <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  summate  <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">X_trials</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">rset</span>, grid <span class="op">=</span> <span class="va">grid</span>, precision <span class="op">=</span> <span class="fl">0.1</span>, method <span class="op">=</span> <span class="st">"conv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y</span> <span class="op">+</span> <span class="va">X_trials</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">true_betas</span></span>
<span></span>
<span><span class="co"># Run OASIS</span></span>
<span><span class="va">beta_oasis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co"># OASIS builds design internally</span></span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>        hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>,</span>
<span>        span <span class="op">=</span> <span class="fl">30</span>  <span class="co"># HRF duration</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"OASIS results:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; OASIS results:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_oasis</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 42 100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean beta:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">beta_oasis</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean beta: 1.012</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta SD:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">beta_oasis</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta SD: 0.613</span></span></code></pre></div>
<div class="section level3">
<h3 id="visualizing-the-design">Visualizing the Design<a class="anchor" aria-label="anchor" href="#visualizing-the-design"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"ggplot2"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dfX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Time  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_trials</span><span class="op">)</span><span class="op">)</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X_trials</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Trial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X_trials</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_trials</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_trials</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfX</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">Trial</span>, fill <span class="op">=</span> <span class="va">Value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Trial-wise design (SPMG1)"</span>, x <span class="op">=</span> <span class="st">"Time (TR)"</span>, y <span class="op">=</span> <span class="st">"Trial"</span>, fill <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/design-viz-1.png" alt="Trial-wise design matrix heatmap (time x trial) for the SPMG1 HRF." width="1200"></p>
</div>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<pre><code><span><span class="co">#&gt; R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] fmrilss_0.1.0      fmrihrf_0.1.0.9000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] Matrix_1.7-3        gtable_0.3.6        jsonlite_2.0.0     </span></span>
<span><span class="co">#&gt;  [4] compiler_4.5.1      Rcpp_1.1.0          assertthat_0.2.1   </span></span>
<span><span class="co">#&gt;  [7] jquerylib_0.1.4     splines_4.5.1       systemfonts_1.3.1  </span></span>
<span><span class="co">#&gt; [10] scales_1.4.0        textshaping_1.0.4   uuid_1.2-1         </span></span>
<span><span class="co">#&gt; [13] yaml_2.3.10         fastmap_1.2.0       lattice_0.22-7     </span></span>
<span><span class="co">#&gt; [16] ggplot2_4.0.0       R6_2.6.1            labeling_0.4.3     </span></span>
<span><span class="co">#&gt; [19] knitr_1.50          desc_1.4.3          RColorBrewer_1.1-3 </span></span>
<span><span class="co">#&gt; [22] bslib_0.9.0         rlang_1.1.6         cachem_1.1.0       </span></span>
<span><span class="co">#&gt; [25] xfun_0.53           S7_0.2.0            fs_1.6.6           </span></span>
<span><span class="co">#&gt; [28] sass_0.4.10         viridisLite_0.4.2   memoise_2.0.1      </span></span>
<span><span class="co">#&gt; [31] cli_3.6.5           withr_3.0.2         pkgdown_2.1.3      </span></span>
<span><span class="co">#&gt; [34] magrittr_2.0.4      digest_0.6.37       grid_4.5.1         </span></span>
<span><span class="co">#&gt; [37] bigmemory.sri_0.1.8 lifecycle_1.0.4     bigmemory_4.6.4    </span></span>
<span><span class="co">#&gt; [40] vctrs_0.6.5         evaluate_1.0.5      glue_1.8.0         </span></span>
<span><span class="co">#&gt; [43] farver_2.1.2        numDeriv_2016.8-1.1 fmriAR_0.1.0       </span></span>
<span><span class="co">#&gt; [46] ragg_1.5.0          rmarkdown_2.30      purrr_1.1.0        </span></span>
<span><span class="co">#&gt; [49] tools_4.5.1         htmltools_0.5.8.1</span></span></code></pre>
<p>Notice how OASIS takes a design specification rather than a pre-built
design matrix. This allows it to construct the optimal internal
representation for efficient computation. The results are identical to
what you’d get from standard LSS, but computed much more
efficiently.</p>
</div>
<div class="section level2">
<h2 id="the-power-of-ridge-regularization">The Power of Ridge Regularization<a class="anchor" aria-label="anchor" href="#the-power-of-ridge-regularization"></a>
</h2>
<p>One of OASIS’s most valuable features is built-in ridge
regularization. In rapid event-related designs, the close temporal
spacing of trials can lead to highly correlated regressors and unstable
estimates. Ridge regression adds a small penalty term that “shrinks”
estimates toward zero, trading a small amount of bias for a large
reduction in variance.</p>
<p>OASIS offers two approaches to ridge regularization, each suited to
different scenarios. Let’s explore both:</p>
<div class="section level3">
<h3 id="absolute-ridge-regularization">Absolute Ridge Regularization<a class="anchor" aria-label="anchor" href="#absolute-ridge-regularization"></a>
</h3>
<p>With absolute ridge, you specify fixed penalty values that are added
to the diagonal of the normal equations. This approach gives you direct
control over the regularization strength:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Absolute ridge: fixed penalty values</span></span>
<span><span class="va">beta_ridge_abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"absolute"</span>,</span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.1</span>,  <span class="co"># Penalty on trial regressor</span></span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.1</span>   <span class="co"># Penalty on aggregator regressor</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare with unregularized</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Comparison with unregularized:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Comparison with unregularized:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Correlation:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">beta_oasis</span><span class="op">)</span>,</span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">beta_ridge_abs</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Correlation: 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean absolute difference:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">beta_oasis</span> <span class="op">-</span> <span class="va">beta_ridge_abs</span><span class="op">)</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean absolute difference: 0.0096</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fractional-ridge-regularization">Fractional Ridge Regularization<a class="anchor" aria-label="anchor" href="#fractional-ridge-regularization"></a>
</h3>
<p>Fractional ridge scales the penalty relative to the “energy” (sum of
squares) in the design matrix. This adaptive approach automatically
adjusts to the scale of your data:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fractional ridge: penalty as fraction of design energy</span></span>
<span><span class="va">beta_ridge_frac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.05</span>,  <span class="co"># 5% of mean design energy</span></span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.05</span>   <span class="co"># 5% of mean aggregator energy</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ridge typically reduces variance in estimates</span></span>
<span><span class="va">var_unreg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">beta_oasis</span>, <span class="fl">2</span>, <span class="va">var</span><span class="op">)</span></span>
<span><span class="va">var_ridge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">beta_ridge_frac</span>, <span class="fl">2</span>, <span class="va">var</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nVariance reduction with ridge:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variance reduction with ridge:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean variance (unregularized):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var_unreg</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean variance (unregularized): 0.3664</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean variance (ridge):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var_ridge</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean variance (ridge): 0.3319</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Reduction:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var_ridge</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var_unreg</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Reduction: 9.4 %</span></span></code></pre></div>
<p>The variance reduction demonstrates ridge regression’s stabilizing
effect. In practice, this translates to more reliable estimates,
especially in noisy data or complex designs.</p>
</div>
</div>
<div class="section level2">
<h2 id="working-with-multi-basis-hrfs">Working with Multi-Basis HRFs<a class="anchor" aria-label="anchor" href="#working-with-multi-basis-hrfs"></a>
</h2>
<p>Real hemodynamic responses rarely match the canonical HRF perfectly.
They might peak earlier or later, be wider or narrower, or have
different undershoot characteristics. Multi-basis HRF models capture
this variability by representing the response as a weighted combination
of basis functions.</p>
<p>OASIS handles multi-basis HRFs naturally, returning separate
estimates for each basis component:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use SPMG3: canonical + temporal derivative + dispersion derivative</span></span>
<span><span class="va">beta_spmg3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>        hrf <span class="op">=</span> <span class="va">HRF_SPMG3</span>,  <span class="co"># 3 basis functions</span></span>
<span>        span <span class="op">=</span> <span class="fl">30</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SPMG3 returns KxN rows where K=number of basis functions, N=number of trials</span></span>
<span><span class="co"># The results are organized in blocks: [trial1_basis1, trial1_basis2, trial1_basis3,</span></span>
<span><span class="co">#                                       trial2_basis1, trial2_basis2, trial2_basis3, ...]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Multi-basis results:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Multi-basis results:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 126 100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Basis functions (K):"</span>, <span class="fl">3</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Basis functions (K): 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Trials (N):"</span>, <span class="va">n_trials</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Trials (N): 42</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Total rows (KxN):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Total rows (KxN): 126</span></span>
<span></span>
<span><span class="co"># Extract components using the K-stride pattern</span></span>
<span><span class="co"># For K=3 basis functions, every 3rd row starting from position k gives basis k</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">3</span>  <span class="co"># Number of basis functions in SPMG3</span></span>
<span><span class="va">canonical_betas</span> <span class="op">&lt;-</span> <span class="va">beta_spmg3</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">K</span><span class="op">)</span>, <span class="op">]</span>    <span class="co"># Basis 1: Canonical</span></span>
<span><span class="va">temporal_betas</span> <span class="op">&lt;-</span> <span class="va">beta_spmg3</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">K</span><span class="op">)</span>, <span class="op">]</span>     <span class="co"># Basis 2: Temporal derivative</span></span>
<span><span class="va">dispersion_betas</span> <span class="op">&lt;-</span> <span class="va">beta_spmg3</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_spmg3</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">K</span><span class="op">)</span>, <span class="op">]</span>   <span class="co"># Basis 3: Dispersion derivative</span></span>
<span></span>
<span><span class="co"># Verify dimensions: each should be n_trials x n_voxels</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nExtracted component dimensions:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Extracted component dimensions:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Each basis matrix:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">canonical_betas</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Each basis matrix: 42 100</span></span>
<span></span>
<span><span class="co"># Analyze contributions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nBasis function contributions:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Basis function contributions:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Canonical mean |beta|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">canonical_betas</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Canonical mean |beta|: 1.065</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Temporal deriv mean |beta|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">temporal_betas</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Temporal deriv mean |beta|: 0.861</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Dispersion deriv mean |beta|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">dispersion_betas</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Dispersion deriv mean |beta|: 1.463</span></span>
<span></span>
<span><span class="co"># Visualize first voxel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">canonical_betas</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"b"</span>, main <span class="op">=</span> <span class="st">"Canonical"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Beta"</span>, xlab <span class="op">=</span> <span class="st">"Trial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">temporal_betas</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"b"</span>, main <span class="op">=</span> <span class="st">"Temporal Derivative"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Beta"</span>, xlab <span class="op">=</span> <span class="st">"Trial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dispersion_betas</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"b"</span>, main <span class="op">=</span> <span class="st">"Dispersion Derivative"</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"Beta"</span>, xlab <span class="op">=</span> <span class="st">"Trial"</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/multi-basis-1.png" alt="Multi-basis HRF example (SPMG3): canonical, temporal, and dispersion derivative components with summary statistics and per-basis plots." width="1200"></p>
<p>The multi-basis approach reveals how the hemodynamic response varies
across trials. Large temporal derivative values suggest timing
variability, while dispersion derivative values indicate width changes.
This information can be valuable for understanding physiological
variations or task-related modulations of the hemodynamic response.</p>
</div>
<div class="section level2">
<h2 id="pervoxel-hrfs-with-oasisvoxhrf">Per‑Voxel HRFs with OASIS‑VOXHRF<a class="anchor" aria-label="anchor" href="#pervoxel-hrfs-with-oasisvoxhrf"></a>
</h2>
<p>Some datasets benefit from estimating an HRF shape per voxel before
computing trial amplitudes. The OASIS‑VOXHRF mode adds a fast, two‑pass
workflow that stays entirely within the OASIS idiom:</p>
<ul>
<li>Pass A: estimate a voxel‑wise HRF shape in a chosen basis by solving
a tiny K×K ridge system using an aggregate per‑basis design. You can
optionally nudge shapes toward a reference (shape prior) and add a small
roughness penalty.</li>
<li>Pass B: compute single‑trial betas using your voxel‑specific HRFs
via the existing <code><a href="../reference/lss_with_hrf.html">lss_with_hrf()</a></code> C++ engine.</li>
</ul>
<p>Enable it by setting <code>oasis$hrf_mode = "voxel_ridge"</code> and,
optionally, tuning the knobs below. Defaults keep constraints off for
maximal flexibility.</p>
<p>How it differs from HRF grid search - Grid search (above) selects a
single global HRF for the whole dataset/ROI by scoring a small set of
candidate shapes, then refitting once with the winner. It is fast and
robust when you expect a largely homogeneous HRF, but it cannot capture
voxel‑to‑voxel shape differences. - VOXHRF estimates an HRF shape per
voxel in a chosen basis (e.g., SPMG3, FIR) and then fits trial betas
with those voxel‑specific shapes. It captures spatial heterogeneity and
lets you regularize toward a reference via a shape prior
(<code>lambda_shape</code>), smooth with a roughness penalty
(<code>mu_rough</code>), and optionally shrink weights across voxels.
With a very strong shape prior, VOXHRF reduces to the canonical‑HRF
OASIS solution. - In practice: start with a global HRF via grid search
for stability and speed; use VOXHRF when you need spatially varying
shapes or when multi‑basis/FIR modeling is important.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta_voxhrf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG3</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    hrf_mode      <span class="op">=</span> <span class="st">"voxel_ridge"</span>,</span>
<span>    lambda_shape  <span class="op">=</span> <span class="fl">5</span>,       <span class="co"># pull toward reference shape (e.g., canonical)</span></span>
<span>    mu_rough      <span class="op">=</span> <span class="fl">0</span>,       <span class="co"># optional roughness (0 = off)</span></span>
<span>    shrink_global <span class="op">=</span> <span class="fl">0.05</span>,    <span class="co"># small global shrink for stability</span></span>
<span>    orient_ref    <span class="op">=</span> <span class="cn">TRUE</span>     <span class="co"># flip shapes to have positive orientation</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_voxhrf</span><span class="op">)</span></span></code></pre></div>
<p>Notes - Uses the same confound residualization and optional whitening
as the standard OASIS path. - Defaults: no shape prior, no roughness, no
shrink; opt in as needed for rapid designs. - With a very strong shape
prior, results approach canonical‑HRF OASIS.</p>
</div>
<div class="section level2">
<h2 id="sharedbasis-hrf-matching-sbhm">Shared‑Basis HRF Matching (SBHM)<a class="anchor" aria-label="anchor" href="#sharedbasis-hrf-matching-sbhm"></a>
</h2>
<p>SBHM learns a single low‑rank time basis from a large HRF library and
fits voxels in that same coordinate system. Matching is then a fast
cosine lookup in r‑dimensional space, and trial‑wise amplitudes come
from projecting the r‑coefficients onto each voxel’s matched
coordinates. This provides design‑aware HRF selection without FIRs or
manifold alignment.</p>
<p><strong>Note:</strong> This section provides a quick demonstration of
SBHM. For comprehensive documentation including parameter guidance,
performance considerations, and troubleshooting, see the dedicated
<strong>SBHM vignette</strong>
(<code><a href="../articles/sbhm.html">vignette("sbhm", package = "fmrilss")</a></code>).</p>
<p>Workflow - Build a library via <code><a href="https://bbuchsbaum.github.io/fmrihrf/reference/hrf_library.html" class="external-link">fmrihrf::hrf_library()</a></code>
over a parameter grid; learn rank‑r basis B by SVD. - Prepass: fit r
coefficients per voxel with the SBHM basis, then match to the closest
library member in whitened, L2‑normalized coefficient space. - LSS: run
OASIS with K=r (the SBHM HRF) to get r×trial coefficients; project onto
matched coordinates for scalar amplitudes.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1) Build an HRF library on the TR grid using fmrihrf::hrf_library</span></span>
<span><span class="va">param_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">10</span><span class="op">)</span>, rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">1.0</span>, <span class="fl">1.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gamma_fun</span>  <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">shape</span>, <span class="va">rate</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/hrf_gamma.html" class="external-link">hrf_gamma</a></span><span class="op">(</span><span class="va">t</span>, shape <span class="op">=</span> <span class="va">shape</span>, rate <span class="op">=</span> <span class="va">rate</span><span class="op">)</span></span>
<span>  <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/as_hrf.html" class="external-link">as_hrf</a></span><span class="op">(</span><span class="va">f</span>, span <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sbhm</span> <span class="op">&lt;-</span> <span class="fu">sbhm_build</span><span class="op">(</span></span>
<span>  library_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">gamma_fun</span>, pgrid <span class="op">=</span> <span class="va">param_grid</span>, span <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>,</span>
<span>  r <span class="op">=</span> <span class="fl">6</span>, sframe <span class="op">=</span> <span class="va">sframe</span>, baseline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, normalize <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2) Define design (SBHM HRF is injected automatically by lss_sbhm)</span></span>
<span><span class="va">design_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>  cond   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, duration <span class="op">=</span> <span class="fl">0</span>, span <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3) Run end-to-end SBHM: prepass -&gt; match -&gt; OASIS(K=r) -&gt; projection</span></span>
<span><span class="va">res_sbhm</span> <span class="op">&lt;-</span> <span class="fu">lss_sbhm</span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  sbhm <span class="op">=</span> <span class="va">sbhm</span>,</span>
<span>  design_spec <span class="op">=</span> <span class="va">design_spec</span>,</span>
<span>  Nuisance <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"ar"</span>, exact_first <span class="op">=</span> <span class="st">"ar1"</span><span class="op">)</span>,</span>
<span>  match <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shrink <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="fl">0.0</span>, ref <span class="op">=</span> <span class="va">sbhm</span><span class="op">$</span><span class="va">ref</span><span class="op">$</span><span class="va">alpha_ref</span><span class="op">)</span>, whiten <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>, ridge_x <span class="op">=</span> <span class="fl">0</span>, ridge_b <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  return <span class="op">=</span> <span class="st">"amplitude"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"SBHM results:\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Amplitude dims:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean amplitude:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Top-1/-2 margin (median):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">margin</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Optional: compare against canonical LSS amplitudes for reference</span></span>
<span><span class="va">beta_spmg1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sframe <span class="op">=</span> <span class="va">sframe</span>, cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Corr(SBHM amp, canonical beta):"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">res_sbhm</span><span class="op">$</span><span class="va">amplitude</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">beta_spmg1</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<p>Notes - The library and data live in the same coordinate system: if a
library HRF is h_k = B α_k, its trial regressor is exactly X α_k where X
are the per‑basis regressors, so comparing β̄_v to α_k is principled. -
Whitening divides coefficients by the singular values (Σ_r^{-1}),
equalizing basis directions before cosine matching; recommended. -
Confidence can be read from the margin between top‑1 and top‑2 cosine
matches; small margins indicate ambiguity.</p>
</div>
<div class="section level2">
<h2 id="whitening-semantics">Whitening Semantics<a class="anchor" aria-label="anchor" href="#whitening-semantics"></a>
</h2>
<p>When <code>oasis$whiten = "ar1"</code> or
<code>prewhiten = list(...)</code> is used, OASIS:</p>
<ul>
<li>Estimates the AR parameter after deflating the nuisance space used
in the model (intercept <code>Z</code>, user <code>Nuisance</code>, and
any <code>design_spec$others</code>). This gives a more stable rho.</li>
<li>Applies the same linear transform <code>W</code> to the data
<code>Y</code>, the trial design <code>X</code>, and the nuisance
design, so that the whitened GLS is algebraically equivalent to the
unwhitened model.</li>
</ul>
<p>Implications - Consistency matters: if you manually whiten outside
OASIS, use the same nuisance space for rho estimation and apply
<code>W</code> to <code>Y</code>, <code>X</code>, and nuisance.
Otherwise you may see small but systematic differences. - Coefficients
are identical up to floating‑point when whitening is applied
consistently. Standard errors and t‑statistics are computed in the
whitened space automatically by OASIS. - Whitening does not change the
model degrees of freedom; it re‑weights timepoints to account for
autocorrelation. - This behavior is shared by the VOXHRF path; whitening
is applied once and consistently to all model components.</p>
</div>
<div class="section level2">
<h2 id="non-parametric-hrf-modeling-with-fir">Non-Parametric HRF Modeling with FIR<a class="anchor" aria-label="anchor" href="#non-parametric-hrf-modeling-with-fir"></a>
</h2>
<p>Sometimes you want to make no assumptions about HRF shape at all. The
Finite Impulse Response (FIR) basis provides a completely non-parametric
approach, estimating the response at each time point independently:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create FIR basis with 15 time bins (2s width over a 30s window)</span></span>
<span><span class="va">fir_hrf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/hrf_fir_generator.html" class="external-link">hrf_fir_generator</a></span><span class="op">(</span>nbasis <span class="op">=</span> <span class="fl">15</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Robustly derive bin width from attributes. Some fmrihrf versions</span></span>
<span><span class="co"># do not expose bin_width via attr(params).</span></span>
<span><span class="va">n_bins</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">fir_hrf</span>, <span class="st">"nbasis"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">span_fir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">fir_hrf</span>, <span class="st">"span"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bin_width</span> <span class="op">&lt;-</span> <span class="va">span_fir</span> <span class="op">/</span> <span class="va">n_bins</span></span>
<span></span>
<span><span class="va">beta_fir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>        hrf <span class="op">=</span> <span class="va">fir_hrf</span>,</span>
<span>        span <span class="op">=</span> <span class="fl">30</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.2</span>,  <span class="co"># Moderate ridge improves stability for high-dimensional FIR fits</span></span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.2</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"FIR basis results:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; FIR basis results:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_fir</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 630 100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Time bins per trial:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">beta_fir</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_trials</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Time bins per trial: 15</span></span>
<span></span>
<span><span class="co"># Organise coefficients as (time bin x trial x voxel)</span></span>
<span><span class="va">fir_array</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">beta_fir</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_bins</span>, <span class="va">n_trials</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">beta_fir</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Average across trials and voxels to recover a smooth HRF estimate</span></span>
<span><span class="va">fir_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fir_array</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">fir_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fir_array</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">n_trials</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">beta_fir</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">time_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">(</span><span class="va">n_bins</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">bin_width</span>, by <span class="op">=</span> <span class="va">bin_width</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot mean HRF with +/- 1 SE ribbon</span></span>
<span><span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">fir_mean</span> <span class="op">+</span> <span class="va">fir_se</span></span>
<span><span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">fir_mean</span> <span class="op">-</span> <span class="va">fir_se</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">time_points</span>, <span class="va">fir_mean</span>, type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">lower</span>, <span class="va">upper</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"FIR-derived HRF (mean across trials/voxels)"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Time (seconds)"</span>, ylab <span class="op">=</span> <span class="st">"Response"</span>,</span>
<span>     col <span class="op">=</span> <span class="st">"navy"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html" class="external-link">polygon</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">time_points</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">time_points</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">upper</span>, <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">lower</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="st">"navy"</span>, alpha.f <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, border <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time_points</span>, <span class="va">fir_mean</span>, col <span class="op">=</span> <span class="st">"navy"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add canonical HRF sampled on the same grid for reference</span></span>
<span><span class="va">canonical</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">HRF_SPMG1</span>, <span class="va">time_points</span><span class="op">)</span></span>
<span><span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">fir_mean</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">canonical</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time_points</span>, <span class="va">canonical</span> <span class="op">*</span> <span class="va">scale_factor</span>, col <span class="op">=</span> <span class="st">"firebrick"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FIR mean"</span>, <span class="st">"+/- 1 SE"</span>, <span class="st">"Canonical (scaled)"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"navy"</span>, <span class="cn">NA</span>, <span class="st">"firebrick"</span><span class="op">)</span>,</span>
<span>       lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>       lwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">15</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>       pt.cex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">2</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>       pt.bg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/adjustcolor.html" class="external-link">adjustcolor</a></span><span class="op">(</span><span class="st">"navy"</span>, alpha.f <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>       bty <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/fir-basis-1.png" alt="FIR-derived HRF: mean response across trials/voxels with shaded standard error band and canonical HRF overlay." width="1200"></p>
<p>The FIR approach reveals the actual shape of the hemodynamic response
without parametric constraints. Because each trial now contributes one
coefficient per time bin, individual voxel-level estimates can look
jagged—the variance is simply much higher than in the single-parameter
canonical fit. Averaging across trials and voxels (and adding a modest
ridge penalty) recovers a smooth, HRF-like curve while still allowing
deviations from the canonical shape. In practice you would typically
pool information across voxels/regions or apply additional
smoothing/regularization when working with FIR bases.</p>
</div>
<div class="section level2">
<h2 id="optimizing-hrf-models-through-grid-search">Optimizing HRF Models Through Grid Search<a class="anchor" aria-label="anchor" href="#optimizing-hrf-models-through-grid-search"></a>
</h2>
<p>When you’re unsure which HRF model best fits your data, OASIS can
efficiently evaluate multiple candidates. In this vignette we perform a
global HRF selection: we choose a single HRF shape shared by all voxels
(or an ROI) and then refit the model using that HRF. This keeps
selection fast and stable. It does not estimate voxel‑specific HRFs; for
that workflow, see the “Voxel‑wise HRF” vignette or use a
multi‑basis/FIR model.</p>
<p>There are two ways to drive selection: - Manual scoring (shown
below): loop through candidates, score the fit, pick the best, then
refit once on the full voxel set. - Built‑in selection: pass a grid via
<code>oasis$design_spec$hrf_grid</code> and let OASIS pick a single best
HRF internally using a matched‑filter score.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a grid of HRF models with varying parameters</span></span>
<span><span class="va">hrf_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_lwu_grid.html">create_lwu_grid</a></span><span class="op">(</span></span>
<span>  tau_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span>,      <span class="co"># Peak time</span></span>
<span>  sigma_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3.5</span><span class="op">)</span>,  <span class="co"># Width</span></span>
<span>  rho_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span><span class="op">)</span>,  <span class="co"># Undershoot</span></span>
<span>  n_tau <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  n_sigma <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  n_rho <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Testing"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">hrf_grid</span><span class="op">$</span><span class="va">hrfs</span><span class="op">)</span>, <span class="st">"different HRF models\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Testing 12 different HRF models</span></span>
<span></span>
<span><span class="co"># Global HRF grid search (single HRF for all voxels):</span></span>
<span><span class="co"># Score each candidate on a small voxel subset, then refit all voxels with the best.</span></span>
<span><span class="va">best_fit</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span><span class="va">best_idx</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">hrf_grid</span><span class="op">$</span><span class="va">hrfs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create HRF object</span></span>
<span>  <span class="va">tau_val</span> <span class="op">&lt;-</span> <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">sigma_val</span> <span class="op">&lt;-</span> <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">rho_val</span> <span class="op">&lt;-</span> <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">rho</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">hrf_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/hrf_lwu.html" class="external-link">hrf_lwu</a></span><span class="op">(</span><span class="va">t</span>, tau <span class="op">=</span> <span class="va">tau_val</span>, sigma <span class="op">=</span> <span class="va">sigma_val</span>, rho <span class="op">=</span> <span class="va">rho_val</span>, normalize <span class="op">=</span> <span class="st">"height"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hrf"</span>, <span class="st">"function"</span><span class="op">)</span>,</span>
<span>    span <span class="op">=</span> <span class="fl">30</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Fit OASIS with this HRF</span></span>
<span>  <span class="va">beta_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,  <span class="co"># Test on subset for speed</span></span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>    oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>        cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">hrf_obj</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>      ridge_x <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>      ridge_b <span class="op">=</span> <span class="fl">0.01</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate fit (simplified - residual sum of squares)</span></span>
<span>  <span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/samples.html" class="external-link">samples</a></span><span class="op">(</span><span class="va">sframe</span>, global <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">rset</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor_set.html" class="external-link">regressor_set</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>,</span>
<span>                                 fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">onsets</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                 hrf <span class="op">=</span> <span class="va">hrf_obj</span>,</span>
<span>                                 duration <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                 span <span class="op">=</span> <span class="fl">30</span>,</span>
<span>                                 summate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">X_test</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">rset</span>, grid <span class="op">=</span> <span class="va">grid</span>, precision <span class="op">=</span> <span class="fl">0.1</span>, method <span class="op">=</span> <span class="st">"conv"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">fitted</span> <span class="op">&lt;-</span> <span class="va">X_test</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta_test</span></span>
<span>  <span class="va">rss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span> <span class="op">-</span> <span class="va">fitted</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">-</span><span class="va">rss</span> <span class="op">&gt;</span> <span class="va">best_fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">best_fit</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">rss</span></span>
<span>    <span class="va">best_idx</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Best HRF parameters:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Best HRF parameters:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  tau:"</span>, <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">tau</span><span class="op">[</span><span class="va">best_idx</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   tau: 4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  sigma:"</span>, <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">sigma</span><span class="op">[</span><span class="va">best_idx</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   sigma: 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  rho:"</span>, <span class="va">hrf_grid</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">rho</span><span class="op">[</span><span class="va">best_idx</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   rho: 0.2</span></span>
<span></span>
<span><span class="co"># Refit all voxels with the selected global HRF</span></span>
<span><span class="va">best_hrf</span> <span class="op">&lt;-</span> <span class="va">hrf_grid</span><span class="op">$</span><span class="va">hrfs</span><span class="op">[[</span><span class="va">best_idx</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">beta_global</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">best_hrf</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.01</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Refit with global HRF complete. Beta dims:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_global</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">" x "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Refit with global HRF complete. Beta dims: 42 x 100</span></span></code></pre></div>
<p>Grid search (global) reveals which HRF parameters best explain your
data at the dataset/ROI level. This is complementary to voxel‑wise HRF
modeling: start with a shared HRF for stability, then zoom in with
multi‑basis/FIR when needed.</p>
<p>If you prefer to let OASIS pick the HRF internally, pass the grid
directly. Note this path also selects a single global HRF and proceeds
immediately to fitting; it does not expose the chosen parameters in the
return value:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta_auto_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>      hrf_grid <span class="op">=</span> <span class="va">hrf_grid</span><span class="op">$</span><span class="va">hrfs</span></span>
<span>    <span class="op">)</span>,</span>
<span>    ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>    ridge_x <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    ridge_b <span class="op">=</span> <span class="fl">0.01</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_auto_grid</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="handling-complex-experimental-designs">Handling Complex Experimental Designs<a class="anchor" aria-label="anchor" href="#handling-complex-experimental-designs"></a>
</h2>
<p>Real experiments often involve multiple conditions, with some trials
of interest and others serving as nuisance events. OASIS handles these
scenarios through structured condition specification:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create design with two conditions</span></span>
<span><span class="va">onsets_cond1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">280</span>, by <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">onsets_cond2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">280</span>, by <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Condition 1 as target, Condition 2 as nuisance</span></span>
<span><span class="va">beta_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        onsets <span class="op">=</span> <span class="va">onsets_cond1</span>,</span>
<span>        hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>,</span>
<span>        span <span class="op">=</span> <span class="fl">30</span></span>
<span>      <span class="op">)</span>,</span>
<span>      others <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets_cond2</span><span class="op">)</span>  <span class="co"># Other conditions as nuisance</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Multi-condition OASIS:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Multi-condition OASIS:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Analyzing condition 1 trials:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">onsets_cond1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Analyzing condition 1 trials: 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Condition 2 included as nuisance\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Condition 2 included as nuisance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_multi</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 10 100</span></span></code></pre></div>
<p>This approach ensures that variance from other conditions is properly
accounted for without conflating it with the trials of interest.</p>
</div>
<div class="section level2">
<h2 id="beyond-point-estimates-standard-errors-and-diagnostics">Beyond Point Estimates: Standard Errors and Diagnostics<a class="anchor" aria-label="anchor" href="#beyond-point-estimates-standard-errors-and-diagnostics"></a>
</h2>
<p>While beta estimates are valuable, understanding their uncertainty is
crucial for proper inference. OASIS can provide standard errors and
diagnostic information:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Request standard errors</span></span>
<span><span class="va">result_with_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,  <span class="co"># Subset for demonstration</span></span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    return_se <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    return_diag <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Results with diagnostics:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Results with diagnostics:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">result_with_se</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 10 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  SE dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">result_with_se</span><span class="op">$</span><span class="va">se</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   SE dimensions: 10 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean SE:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result_with_se</span><span class="op">$</span><span class="va">se</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean SE: 0.3953</span></span>
<span></span>
<span><span class="co"># Calculate t-statistics</span></span>
<span><span class="va">t_stats</span> <span class="op">&lt;-</span> <span class="va">result_with_se</span><span class="op">$</span><span class="va">beta</span> <span class="op">/</span> <span class="va">result_with_se</span><span class="op">$</span><span class="va">se</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean |t-statistic|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">t_stats</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean |t-statistic|: 1.33</span></span>
<span></span>
<span><span class="co"># Visualize SE across trials</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">result_with_se</span><span class="op">$</span><span class="va">se</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Standard Error Across Trials"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Trial"</span>, ylab <span class="op">=</span> <span class="st">"Mean SE"</span>,</span>
<span>     col <span class="op">=</span> <span class="st">"darkblue"</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/standard-errors-1.png" alt="Standard error and diagnostic outputs from OASIS, illustrating per-trial uncertainty and design metrics." width="1200"></p>
<p>Standard errors reveal which estimates are most reliable. Trials with
higher standard errors might be those with more overlapping responses or
occurring during periods of higher noise.</p>
</div>
<div class="section level2">
<h2 id="performance-in-practice">Performance in Practice<a class="anchor" aria-label="anchor" href="#performance-in-practice"></a>
</h2>
<p>To understand OASIS’s efficiency, let’s conduct systematic benchmarks
comparing it with traditional LSS implementations across different
dataset sizes:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Benchmark across different dataset sizes</span></span>
<span><span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  small  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoints <span class="op">=</span> <span class="fl">300</span>, voxels <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>,</span>
<span>  medium <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoints <span class="op">=</span> <span class="fl">400</span>, voxels <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>,</span>
<span>  large  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoints <span class="op">=</span> <span class="fl">600</span>, voxels <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span>,</span>
<span>  xlarge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoints <span class="op">=</span> <span class="fl">800</span>, voxels <span class="op">=</span> <span class="fl">16000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">benchmark_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">size_name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sizes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_time</span> <span class="op">&lt;-</span> <span class="va">sizes</span><span class="op">[[</span><span class="va">size_name</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'timepoints'</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">n_vox</span>  <span class="op">&lt;-</span> <span class="va">sizes</span><span class="op">[[</span><span class="va">size_name</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'voxels'</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Create test data</span></span>
<span>  <span class="va">Y_bench</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_time</span> <span class="op">*</span> <span class="va">n_vox</span><span class="op">)</span>, <span class="va">n_time</span>, <span class="va">n_vox</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create sampling frame and onsets for this size</span></span>
<span>  <span class="va">sframe_bench</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/sampling_frame.html" class="external-link">sampling_frame</a></span><span class="op">(</span>blocklens <span class="op">=</span> <span class="va">n_time</span>, TR <span class="op">=</span> <span class="va">TR</span><span class="op">)</span></span>
<span>  <span class="va">n_trials</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n_time</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">onsets_bench</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="va">n_time</span> <span class="op">-</span> <span class="fl">20</span>, length.out <span class="op">=</span> <span class="va">n_trials</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Standard LSS with pre-built design (shared across methods)</span></span>
<span>  <span class="va">grid_b</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/samples.html" class="external-link">samples</a></span><span class="op">(</span><span class="va">sframe_bench</span>, global <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">rset_b</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/regressor_set.html" class="external-link">regressor_set</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets_bench</span>,</span>
<span>                                   fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">onsets_bench</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                   hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>,</span>
<span>                                   duration <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                   span <span class="op">=</span> <span class="fl">30</span>,</span>
<span>                                   summate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">dm_bench</span> <span class="op">&lt;-</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">rset_b</span>, grid <span class="op">=</span> <span class="va">grid_b</span>, precision <span class="op">=</span> <span class="fl">0.1</span>, method <span class="op">=</span> <span class="st">"conv"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Time standard LSS (R optimized)</span></span>
<span>  <span class="va">time_r_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">beta_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span><span class="va">Y_bench</span>, <span class="va">dm_bench</span>, method <span class="op">=</span> <span class="st">"r_optimized"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Time standard LSS (C++ optimized)</span></span>
<span>  <span class="va">time_cpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">beta_cpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span><span class="va">Y_bench</span>, <span class="va">dm_bench</span>, method <span class="op">=</span> <span class="st">"cpp_optimized"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Time OASIS using the pre-built design (fair comparison)</span></span>
<span>  <span class="va">time_oasis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">beta_oasis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y_bench</span>, X <span class="op">=</span> <span class="va">dm_bench</span>, method <span class="op">=</span> <span class="st">"oasis"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Time OASIS when it also has to build the design internally</span></span>
<span>  <span class="va">time_oasis_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">beta_oasis_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>      Y <span class="op">=</span> <span class="va">Y_bench</span>,</span>
<span>      X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>      oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          sframe <span class="op">=</span> <span class="va">sframe_bench</span>,</span>
<span>          cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            onsets <span class="op">=</span> <span class="va">onsets_bench</span>,</span>
<span>            hrf <span class="op">=</span> <span class="fu">fmrihrf</span><span class="fu">::</span><span class="va"><a href="https://bbuchsbaum.github.io/fmrihrf/reference/HRF_objects.html" class="external-link">HRF_SPMG1</a></span>,</span>
<span>            span <span class="op">=</span> <span class="fl">30</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Store results</span></span>
<span>  <span class="va">benchmark_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">benchmark_results</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Size <span class="op">=</span> <span class="va">size_name</span>,</span>
<span>    Timepoints <span class="op">=</span> <span class="va">n_time</span>,</span>
<span>    Voxels <span class="op">=</span> <span class="va">n_vox</span>,</span>
<span>    Trials <span class="op">=</span> <span class="va">n_trials</span>,</span>
<span>    R_Optimized <span class="op">=</span> <span class="va">time_r_opt</span>,</span>
<span>    CPP_Optimized <span class="op">=</span> <span class="va">time_cpp</span>,</span>
<span>    OASIS <span class="op">=</span> <span class="va">time_oasis</span>,</span>
<span>    OASIS_with_design <span class="op">=</span> <span class="va">time_oasis_build</span>,</span>
<span>    Speedup_vs_R <span class="op">=</span> <span class="va">time_r_opt</span> <span class="op">/</span> <span class="va">time_oasis</span>,</span>
<span>    Speedup_vs_CPP <span class="op">=</span> <span class="va">time_cpp</span> <span class="op">/</span> <span class="va">time_oasis</span>,</span>
<span>    Design_Build_Overhead <span class="op">=</span> <span class="va">time_oasis_build</span> <span class="op">-</span> <span class="va">time_oasis</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Display rounded results for readability</span></span>
<span><span class="va">numeric_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">)</span>, <span class="st">"Size"</span><span class="op">)</span></span>
<span><span class="va">benchmark_display</span> <span class="op">&lt;-</span> <span class="va">benchmark_results</span></span>
<span><span class="va">benchmark_display</span><span class="op">[</span><span class="va">numeric_cols</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">benchmark_display</span><span class="op">[</span><span class="va">numeric_cols</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">benchmark_display</span><span class="op">)</span></span>
<span><span class="co">#&gt;            Size Timepoints Voxels Trials R_Optimized CPP_Optimized OASIS</span></span>
<span><span class="co">#&gt; elapsed   small        300    500     30       0.005         0.008 0.004</span></span>
<span><span class="co">#&gt; elapsed1 medium        400   2000     40       0.016         0.029 0.014</span></span>
<span><span class="co">#&gt; elapsed2  large        600   8000     60       0.076         0.172 0.062</span></span>
<span><span class="co">#&gt; elapsed3 xlarge        800  16000     60       0.179         0.197 0.157</span></span>
<span><span class="co">#&gt;          OASIS_with_design Speedup_vs_R Speedup_vs_CPP Design_Build_Overhead</span></span>
<span><span class="co">#&gt; elapsed              0.016        1.250          2.000                 0.012</span></span>
<span><span class="co">#&gt; elapsed1             0.034        1.143          2.071                 0.020</span></span>
<span><span class="co">#&gt; elapsed2             0.093        1.226          2.774                 0.031</span></span>
<span><span class="co">#&gt; elapsed3             0.205        1.140          1.255                 0.048</span></span>
<span></span>
<span><span class="co"># Visualize scaling</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Time vs dataset size</span></span>
<span><span class="va">ylim_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R_Optimized"</span>, <span class="st">"CPP_Optimized"</span>, <span class="st">"OASIS_with_design"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">benchmark_results</span><span class="op">$</span><span class="va">R_Optimized</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"blue"</span>, pch <span class="op">=</span> <span class="fl">19</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Number of Voxels"</span>, ylab <span class="op">=</span> <span class="st">"Time (seconds)"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Computation Time Scaling"</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ylim_max</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">benchmark_results</span><span class="op">$</span><span class="va">CPP_Optimized</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"darkgreen"</span>, pch <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">benchmark_results</span><span class="op">$</span><span class="va">OASIS</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">17</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">benchmark_results</span><span class="op">$</span><span class="va">OASIS_with_design</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span>, pch <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>,</span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R Optimized"</span>, <span class="st">"C++ Optimized"</span>, <span class="st">"OASIS (pre-built X)"</span>, <span class="st">"OASIS (build design)"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"darkgreen"</span>, <span class="st">"red"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>       pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">19</span>, <span class="fl">15</span>, <span class="fl">17</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>       lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Speedup factor</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">$</span><span class="va">Speedup_vs_R</span>,</span>
<span>        names.arg <span class="op">=</span> <span class="va">benchmark_results</span><span class="op">$</span><span class="va">Size</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"OASIS Speedup vs R Optimized"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Speedup Factor"</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/performance-comparison-1.png" alt="Benchmark plots comparing computation time scaling across R optimized, C++ optimized, and OASIS (with and without design build)." width="1200"></p>
<pre><code>
These benchmarks show that all three optimized backends sit within a few percent of one another across the regimes we tested. The R and fused C++ paths are already very efficient, and OASIS closely tracks them even as we scale to tens of thousands of voxels and dozens of trials. The `OASIS (build design)` curve highlights another key point: if you let OASIS construct the design inside the call you pay the additional cost of HRF convolution, so for apples-to-apples comparisons you should pre-build and reuse `X` just as you would for the other methods.

The exact ordering will vary with hardware, trial spacing, and nuisance structure—on some reruns OASIS edges ahead, on others the R or C++ backend wins by a similar margin. The takeaway is that OASIS keeps pace with the existing optimized solvers while additionally providing HRF-aware design construction, ridge regularization, whitening, and diagnostics.

## Creating Custom HRF Functions

OASIS's flexibility extends to custom HRF functions, allowing you to implement novel hemodynamic models:


``` r
# Create custom double-gamma HRF
custom_hrf &lt;- function(t, a1 = 6, a2 = 16, b1 = 1, b2 = 1, c = 1/6) {
  # Double gamma function
  dgamma(t, a1, b1) - c * dgamma(t, a2, b2)
}

# Wrap as HRF object
custom_hrf_obj &lt;- structure(
  custom_hrf,
  class = c("hrf", "function"),
  span = 30
)

# Use with OASIS
beta_custom &lt;- lss(
  Y = Y[, 1:10],
  X = NULL,
  method = "oasis",
  oasis = list(
    design_spec = list(
      sframe = sframe,
      cond = list(
        onsets = onsets[1:10],
        hrf = custom_hrf_obj,
        span = 30
      )
    )
  )
)

cat("Custom HRF results:\n")
#&gt; Custom HRF results:
cat("  Beta dimensions:", dim(beta_custom), "\n")
#&gt;   Beta dimensions: 10 10
cat("  Mean beta:", round(mean(beta_custom), 3), "\n")
#&gt;   Mean beta: 1.633</code></pre>
<p>This capability allows you to test hypotheses about hemodynamic
response characteristics or adapt models from other software
packages.</p>
</div>
<div class="section level2">
<h2 id="practical-guidance-for-ridge-parameter-selection">Practical Guidance for Ridge Parameter Selection<a class="anchor" aria-label="anchor" href="#practical-guidance-for-ridge-parameter-selection"></a>
</h2>
<p>Choosing appropriate ridge parameters is crucial for optimal
performance. Too little regularization leaves estimates unstable; too
much biases them toward zero. Here’s a systematic approach to
selection:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test different ridge values</span></span>
<span><span class="va">ridge_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">ridge_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ridge</span> <span class="kw">in</span> <span class="va">ridge_values</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">beta_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,</span>
<span>    X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>    oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>        cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      ridge_mode <span class="op">=</span> <span class="st">"fractional"</span>,</span>
<span>      ridge_x <span class="op">=</span> <span class="va">ridge</span>,</span>
<span>      ridge_b <span class="op">=</span> <span class="va">ridge</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">ridge_results</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ridge</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mean_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">beta_r</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sd_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">beta_r</span><span class="op">)</span>,</span>
<span>    condition_number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/kappa.html" class="external-link">kappa</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">beta_r</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Ridge parameter selection:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Ridge parameter selection:</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ridge_results</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Ridge = %s: mean|beta| = %.3f, SD = %.3f, kappa = %.1f\n"</span>,</span>
<span>              <span class="va">r</span>, <span class="va">ridge_results</span><span class="op">[[</span><span class="va">r</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mean_beta</span>,</span>
<span>              <span class="va">ridge_results</span><span class="op">[[</span><span class="va">r</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sd_beta</span>,</span>
<span>              <span class="va">ridge_results</span><span class="op">[[</span><span class="va">r</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">condition_number</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;   Ridge = 0: mean|beta| = 1.059, SD = 0.610, kappa = 9.3</span></span>
<span><span class="co">#&gt;   Ridge = 0.001: mean|beta| = 1.057, SD = 0.609, kappa = 9.3</span></span>
<span><span class="co">#&gt;   Ridge = 0.01: mean|beta| = 1.041, SD = 0.604, kappa = 9.2</span></span>
<span><span class="co">#&gt;   Ridge = 0.05: mean|beta| = 0.973, SD = 0.580, kappa = 8.9</span></span>
<span><span class="co">#&gt;   Ridge = 0.1: mean|beta| = 0.899, SD = 0.552, kappa = 8.5</span></span></code></pre></div>
<p>The condition number (kappa) indicates numerical stability—lower
values suggest more stable estimates. The tradeoff between bias (reduced
mean beta) and variance (reduced SD) guides your choice.</p>
</div>
<div class="section level2">
<h2 id="memory-usage-comparison">Memory Usage Comparison<a class="anchor" aria-label="anchor" href="#memory-usage-comparison"></a>
</h2>
<p>Understanding the memory trade-offs between OASIS and standard LSS is
important for choosing the right method for your computational
resources:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare memory usage across methods</span></span>
<span><span class="va">memory_comparison</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_time</span>, <span class="va">n_vox</span>, <span class="va">n_trials</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Calculate memory requirements (in MB)</span></span>
<span>  <span class="va">double_size</span> <span class="op">&lt;-</span> <span class="fl">8</span>  <span class="co"># bytes per double</span></span>
<span></span>
<span>  <span class="co"># Standard LSS memory (per iteration)</span></span>
<span>  <span class="co"># Stores: current X_trial (n_time x 2), beta result (n_trials x n_vox)</span></span>
<span>  <span class="va">lss_per_iter</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n_time</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">n_vox</span><span class="op">)</span> <span class="op">*</span> <span class="va">double_size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">lss_total</span> <span class="op">&lt;-</span> <span class="va">lss_per_iter</span>  <span class="co"># Only peak memory matters</span></span>
<span></span>
<span>  <span class="co"># OASIS memory (upfront)</span></span>
<span>  <span class="co"># Stores: X (n_time x n_trials), precomputed terms, results</span></span>
<span>  <span class="va">oasis_X</span> <span class="op">&lt;-</span> <span class="va">n_time</span> <span class="op">*</span> <span class="va">n_trials</span> <span class="op">*</span> <span class="va">double_size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">oasis_precomp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n_trials</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">n_trials</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">double_size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span>  <span class="co"># Gram matrices</span></span>
<span>  <span class="va">oasis_results</span> <span class="op">&lt;-</span> <span class="va">n_trials</span> <span class="op">*</span> <span class="va">n_vox</span> <span class="op">*</span> <span class="va">double_size</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">oasis_total</span> <span class="op">&lt;-</span> <span class="va">oasis_X</span> <span class="op">+</span> <span class="va">oasis_precomp</span> <span class="op">+</span> <span class="va">oasis_results</span></span>
<span></span>
<span>  <span class="co"># For multi-basis (K=3), multiply by K</span></span>
<span>  <span class="va">oasis_multibasis</span> <span class="op">&lt;-</span> <span class="va">oasis_total</span> <span class="op">*</span> <span class="fl">3</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    Timepoints <span class="op">=</span> <span class="va">n_time</span>,</span>
<span>    Voxels <span class="op">=</span> <span class="va">n_vox</span>,</span>
<span>    Trials <span class="op">=</span> <span class="va">n_trials</span>,</span>
<span>    LSS_MB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">lss_total</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    OASIS_MB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">oasis_total</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    OASIS_Multi_MB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">oasis_multibasis</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    Ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">oasis_total</span> <span class="op">/</span> <span class="va">lss_total</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    Ratio_Multi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">oasis_multibasis</span> <span class="op">/</span> <span class="va">lss_total</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Test different dataset sizes</span></span>
<span><span class="va">mem_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu">memory_comparison</span><span class="op">(</span><span class="fl">200</span>, <span class="fl">100</span>, <span class="fl">15</span><span class="op">)</span>,    <span class="co"># Small</span></span>
<span>  <span class="fu">memory_comparison</span><span class="op">(</span><span class="fl">300</span>, <span class="fl">1000</span>, <span class="fl">30</span><span class="op">)</span>,   <span class="co"># Medium</span></span>
<span>  <span class="fu">memory_comparison</span><span class="op">(</span><span class="fl">400</span>, <span class="fl">10000</span>, <span class="fl">50</span><span class="op">)</span>,  <span class="co"># Large</span></span>
<span>  <span class="fu">memory_comparison</span><span class="op">(</span><span class="fl">500</span>, <span class="fl">50000</span>, <span class="fl">100</span><span class="op">)</span>  <span class="co"># Very large</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Timepoints Voxels Trials LSS_MB OASIS_MB OASIS_Multi_MB Ratio Ratio_Multi</span></span>
<span><span class="co">#&gt; 1        200    100     15   0.00     0.04           0.11   9.5        28.6</span></span>
<span><span class="co">#&gt; 2        300   1000     30   0.01     0.31           0.92  25.0        75.0</span></span>
<span><span class="co">#&gt; 3        400  10000     50   0.08     3.99          11.96  48.4       145.2</span></span>
<span><span class="co">#&gt; 4        500  50000    100   0.39    38.61         115.82  99.2       297.7</span></span>
<span></span>
<span><span class="co"># Visualize memory scaling</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Memory usage comparison</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">mem_results</span><span class="op">$</span><span class="va">LSS_MB</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"blue"</span>, pch <span class="op">=</span> <span class="fl">19</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Number of Voxels"</span>, ylab <span class="op">=</span> <span class="st">"Memory (MB)"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Memory Usage Comparison"</span>,</span>
<span>     log <span class="op">=</span> <span class="st">"xy"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">mem_results</span><span class="op">$</span><span class="va">OASIS_MB</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">17</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="va">mem_results</span><span class="op">$</span><span class="va">OASIS_Multi_MB</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"b"</span>, col <span class="op">=</span> <span class="st">"orange"</span>, pch <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Standard LSS"</span>, <span class="st">"OASIS"</span>, <span class="st">"OASIS Multi-basis"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"orange"</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">19</span>, <span class="fl">17</span>, <span class="fl">15</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Memory ratio</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ratio"</span>, <span class="st">"Ratio_Multi"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        beside <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        names.arg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">mem_results</span><span class="op">$</span><span class="va">Voxels</span>, <span class="st">"vox"</span><span class="op">)</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"Memory Usage Ratio (OASIS/LSS)"</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"Memory Ratio"</span>,</span>
<span>        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"orange"</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"OASIS"</span>, <span class="st">"OASIS Multi-basis"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">1</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span></span></code></pre></div>
<p><img src="oasis_method_files/figure-html/memory-comparison-1.png" alt="Memory footprint comparison across backends and dataset sizes, illustrating OASIS precompute overhead." width="1200"></p>
<p>As shown, OASIS requires more upfront memory due to precomputed
matrices, but this investment enables its computational efficiency. The
memory overhead is most noticeable with multi-basis HRFs and large
numbers of trials. For memory-constrained systems, consider using
blocked processing or standard LSS for very large datasets.</p>
</div>
<div class="section level2">
<h2 id="advanced-features-for-production-use">Advanced Features for Production Use<a class="anchor" aria-label="anchor" href="#advanced-features-for-production-use"></a>
</h2>
<p>When deploying OASIS in production analyses, several advanced
features enhance efficiency and robustness.</p>
<div class="section level3">
<h3 id="memory-efficient-block-processing">Memory-Efficient Block Processing<a class="anchor" aria-label="anchor" href="#memory-efficient-block-processing"></a>
</h3>
<p>For datasets too large to fit in memory, OASIS can process voxels in
blocks:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For very large datasets, use blocked processing</span></span>
<span><span class="va">block_size</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">n_blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">/</span> <span class="va">block_size</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># OASIS with blocked voxels</span></span>
<span><span class="va">oasis_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>    cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  block_cols <span class="op">=</span> <span class="va">block_size</span>  <span class="co"># Process voxels in blocks</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_blocked</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span><span class="va">Y</span>, X <span class="op">=</span> <span class="cn">NULL</span>, method <span class="op">=</span> <span class="st">"oasis"</span>, oasis <span class="op">=</span> <span class="va">oasis_config</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="temporal-autocorrelation-correction">Temporal Autocorrelation Correction<a class="anchor" aria-label="anchor" href="#temporal-autocorrelation-correction"></a>
</h3>
<p>fMRI data exhibits temporal autocorrelation that can bias standard
errors. OASIS can apply AR(1) prewhitening:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># OASIS with AR(1) prewhitening using new fmriAR integration</span></span>
<span><span class="va">beta_whitened</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"ar"</span>,</span>
<span>    p <span class="op">=</span> <span class="fl">1</span>  <span class="co"># AR(1) model</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"AR(1) whitening applied using fmriAR\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; AR(1) whitening applied using fmriAR</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_whitened</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 10 10</span></span>
<span></span>
<span><span class="co"># Advanced: Auto-select AR order</span></span>
<span><span class="va">beta_auto_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  oasis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sframe <span class="op">=</span> <span class="va">sframe</span>,</span>
<span>      cond <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>onsets <span class="op">=</span> <span class="va">onsets</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, hrf <span class="op">=</span> <span class="va">HRF_SPMG1</span>, span <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"ar"</span>,</span>
<span>    p <span class="op">=</span> <span class="st">"auto"</span>,  <span class="co"># Automatically select optimal AR order</span></span>
<span>    p_max <span class="op">=</span> <span class="fl">4</span>    <span class="co"># Maximum order to consider</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nAuto AR order selection applied\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Auto AR order selection applied</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Beta dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">beta_auto_ar</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Beta dimensions: 10 10</span></span></code></pre></div>
<p>Prewhitening improves the validity of statistical inference,
particularly for standard errors and hypothesis tests.</p>
</div>
<div class="section level3">
<h3 id="advanced-prewhitening-with-fmriar">Advanced Prewhitening with fmriAR<a class="anchor" aria-label="anchor" href="#advanced-prewhitening-with-fmriar"></a>
</h3>
<p>The integration with fmriAR provides sophisticated noise modeling
capabilities beyond simple AR(1):</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Voxel-specific AR parameters</span></span>
<span><span class="va">beta_voxel_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"ar"</span>,</span>
<span>    p <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    pooling <span class="op">=</span> <span class="st">"voxel"</span>  <span class="co"># Estimate separate AR(1) for each voxel</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run-aware AR estimation for multi-run data</span></span>
<span><span class="va">runs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">beta_run_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"ar"</span>,</span>
<span>    p <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>    pooling <span class="op">=</span> <span class="st">"run"</span>,  <span class="co"># Separate parameters per run</span></span>
<span>    runs <span class="op">=</span> <span class="va">runs</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ARMA models for complex noise structure</span></span>
<span><span class="va">beta_arma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"arma"</span>,</span>
<span>    p <span class="op">=</span> <span class="fl">2</span>,  <span class="co"># AR order</span></span>
<span>    q <span class="op">=</span> <span class="fl">1</span>   <span class="co"># MA order</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parcel-based pooling for spatial regularization</span></span>
<span><span class="va">parcels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>, centers <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span>  <span class="co"># Example parcellation</span></span>
<span><span class="va">beta_parcel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lss.html">lss</a></span><span class="op">(</span></span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"oasis"</span>,</span>
<span>  prewhiten <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"ar"</span>,</span>
<span>    p <span class="op">=</span> <span class="st">"auto"</span>,</span>
<span>    pooling <span class="op">=</span> <span class="st">"parcel"</span>,</span>
<span>    parcels <span class="op">=</span> <span class="va">parcels</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>These advanced options provide better noise modeling for complex
experimental designs and data structures.</p>
</div>
</div>
<div class="section level2">
<h2 id="when-oasis-shines-use-case-recommendations">When OASIS Shines: Use Case Recommendations<a class="anchor" aria-label="anchor" href="#when-oasis-shines-use-case-recommendations"></a>
</h2>
<p>Through extensive testing and application, we’ve identified scenarios
where OASIS provides the greatest benefits.</p>
<p>Rapid event-related designs with inter-stimulus intervals under 10
seconds benefit enormously from OASIS’s efficient handling of
overlapping responses. The method’s speed advantage becomes crucial when
dealing with experiments containing hundreds or thousands of trials.</p>
<p>For exploratory analyses where the optimal HRF is unknown, OASIS’s
ability to quickly evaluate multiple HRF models enables data-driven
model selection. The computational efficiency makes it feasible to test
dozens of HRF variants across multiple brain regions.</p>
<p>Large-scale analyses involving whole-brain data or multiple subjects
particularly benefit from OASIS’s speed. What might take days with
traditional LSS can often be completed in hours with OASIS, enabling
more iterative and thorough analyses.</p>
<p>Designs prone to collinearity—whether from rapid presentation, long
HRFs, or correlated experimental factors—benefit from OASIS’s integrated
ridge regression. The regularization happens naturally within the
estimation framework rather than requiring post-hoc adjustments.</p>
</div>
<div class="section level2">
<h2 id="limitations-and-considerations">Limitations and Considerations<a class="anchor" aria-label="anchor" href="#limitations-and-considerations"></a>
</h2>
<p>While OASIS offers substantial advantages, it’s important to
understand its limitations and when simpler approaches might
suffice.</p>
<p>The method requires more memory than iterative LSS approaches since
it constructs larger intermediate matrices. For extremely large datasets
on memory-constrained systems, traditional LSS with careful memory
management might be necessary.</p>
<p>OASIS’s design specification system, while powerful, has a learning
curve. For simple analyses with pre-constructed design matrices,
standard LSS might be more straightforward to implement.</p>
<p>The mathematical optimizations that make OASIS fast also make it less
transparent. If you need to understand or modify the estimation
procedure, the traditional LSS implementation offers clearer code
paths.</p>
</div>
<div class="section level2">
<h2 id="looking-ahead">Looking Ahead<a class="anchor" aria-label="anchor" href="#looking-ahead"></a>
</h2>
<p>OASIS represents the current state-of-the-art in LSS implementation,
combining theoretical rigor with computational efficiency. As fMRI data
continues to grow in resolution and complexity, methods like OASIS
become not just useful but essential for practical analysis.</p>
<p>Future developments might include adaptive regularization that
automatically selects optimal ridge parameters, integration with machine
learning frameworks for end-to-end optimization, and extensions to
handle even more complex experimental designs.</p>
<p>The <code>fmrilss</code> package will continue to evolve with these
advances, maintaining OASIS as a cornerstone of efficient trial-wise
estimation. Whether you’re working with standard datasets or pushing the
boundaries of fMRI acquisition, OASIS provides the tools you need for
rigorous, efficient analysis.</p>
</div>
<div class="section level2">
<h2 id="summary-and-next-steps">Summary and Next Steps<a class="anchor" aria-label="anchor" href="#summary-and-next-steps"></a>
</h2>
<p>This vignette has taken you through the full capabilities of the
OASIS method, from basic usage to advanced features. You’ve seen how
OASIS achieves dramatic speedups through mathematical reformulation,
provides numerical stability through integrated ridge regression,
handles flexible HRF models seamlessly, and scales to large datasets
efficiently.</p>
<p>To continue your journey, explore the getting started vignette for
foundational LSS concepts, the voxel-wise HRF vignette for spatial
modeling of hemodynamic responses, and the package examples directory
for real-world applications. The theoretical details of OASIS are being
prepared for publication, offering deeper insights into the mathematical
innovations that make this method possible.</p>
<p>OASIS transforms LSS from a computationally intensive procedure to a
practical tool for everyday fMRI analysis. By combining speed,
flexibility, and robustness, it enables analyses that would otherwise be
infeasible, opening new possibilities for understanding brain function
through event-related fMRI.</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>See <code><a href="../articles/getting_started.html">vignette("getting_started")</a></code> for LSS basics See
<code><a href="../articles/voxel-wise-hrf.html">vignette("voxel-wise-hrf")</a></code> for spatial HRF variation Review
the <code>examples/oasis_example.R</code> for additional demonstrations
Consult the OASIS paper (in preparation) for theoretical details</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Brad Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
